<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabliczka MnoÅ¼enia - Minecraft Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --dirt: #8B6914; --dirt-dark: #6B4F0A;
            --grass: #5D9B2A; --grass-dark: #4A7B20;
            --stone: #7F7F7F; --stone-dark: #5F5F5F;
            --wood: #BC9862; --wood-dark: #8B6914;
            --diamond: #5DECF5; --gold: #FCDB05; --emerald: #17DD62;
            --redstone: #FF0000; --obsidian: #1B1029;
            --sky-top: #78A7FF; --sky-bottom: #C9E4FF;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bottom) 60%, var(--grass) 60%, var(--grass-dark) 62%, var(--dirt) 62%, var(--dirt-dark) 100%);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; image-rendering: pixelated;
        }

        .clouds { position: fixed; top: 0; left: 0; width: 100%; height: 60vh; pointer-events: none; z-index: 0; overflow: hidden; }
        .cloud { position: absolute; background: white; opacity: 0.9; animation: float-cloud linear infinite; }
        .cloud::before, .cloud::after { content: ''; position: absolute; background: white; }
        .cloud-1 { width: 80px; height: 30px; top: 40px; animation-duration: 45s; }
        .cloud-1::before { width: 40px; height: 20px; top: -15px; left: 10px; }
        .cloud-1::after { width: 30px; height: 15px; top: -10px; left: 40px; }
        .cloud-2 { width: 100px; height: 35px; top: 100px; animation-duration: 60s; animation-delay: -20s; }
        .cloud-2::before { width: 50px; height: 25px; top: -18px; left: 15px; }
        .cloud-2::after { width: 35px; height: 18px; top: -12px; left: 55px; }
        .cloud-3 { width: 60px; height: 25px; top: 70px; animation-duration: 55s; animation-delay: -35s; }
        .cloud-3::before { width: 30px; height: 15px; top: -10px; left: 8px; }
        .cloud-3::after { width: 25px; height: 12px; top: -8px; left: 30px; }
        @keyframes float-cloud { from { left: -150px; } to { left: 110%; } }

        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .particle { position: absolute; width: 8px; height: 8px; pointer-events: none; animation: particle-fall 1s ease-out forwards; }
        @keyframes particle-fall { 0% { opacity: 1; transform: scale(1) translateY(0); } 100% { opacity: 0; transform: scale(0.3) translateY(60px); } }

        .game-container { position: relative; z-index: 1; width: 100%; max-width: 700px; padding: 20px; margin-top: 20px; }

        .title { text-align: center; margin-bottom: 20px; }
        .title h1 { font-size: 18px; color: #333; text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff; line-height: 1.6; }
        .title h1 .green { color: var(--grass-dark); }
        .title h1 .brown { color: var(--dirt-dark); }

        .mc-panel {
            background: #C6C6C6; border: 3px solid #000;
            box-shadow: inset 2px 2px 0 #FFFFFF, inset -2px -2px 0 #555555;
            padding: 16px; margin-bottom: 16px;
        }

        .stats-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .stat { display: flex; align-items: center; gap: 6px; font-size: 10px; color: #333; }

        .xp-section { margin-top: 10px; }
        .xp-label { font-size: 9px; color: #333; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .xp-bar-bg { height: 16px; background: #222; border: 2px solid #000; box-shadow: inset 1px 1px 0 #444; position: relative; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(180deg, #7FFF00, #32CD32); transition: width 0.5s ease; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2); }
        .xp-bar-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 7px; color: #fff; text-shadow: 1px 1px 0 #000; }

        .question-area { text-align: center; padding: 20px 10px; }
        .question-text { font-size: 28px; color: #3F3F3F; text-shadow: 2px 2px 0 #aaa; margin-bottom: 20px; letter-spacing: 4px; }
        .answer-row { display: flex; align-items: center; justify-content: center; gap: 10px; }

        .answer-input {
            font-family: 'Press Start 2P', monospace; font-size: 22px; width: 140px; padding: 10px;
            text-align: center; background: #000; color: #fff; border: 3px solid #555;
            box-shadow: inset 2px 2px 0 #333; outline: none;
        }
        .answer-input:focus { border-color: var(--diamond); box-shadow: inset 2px 2px 0 #333, 0 0 10px rgba(93,236,245,0.5); }
        .answer-input.correct { border-color: var(--emerald); box-shadow: inset 2px 2px 0 #333, 0 0 15px rgba(23,221,98,0.6); }
        .answer-input.wrong { border-color: var(--redstone); box-shadow: inset 2px 2px 0 #333, 0 0 15px rgba(255,0,0,0.6); animation: shake 0.4s ease; }
        @keyframes shake { 0%,100% { transform: translateX(0); } 20% { transform: translateX(-8px); } 40% { transform: translateX(8px); } 60% { transform: translateX(-6px); } 80% { transform: translateX(4px); } }

        .mc-btn {
            font-family: 'Press Start 2P', monospace; font-size: 12px; padding: 10px 20px;
            background: #999; color: #fff; border: 3px solid #000;
            box-shadow: inset 2px 2px 0 #CCC, inset -2px -2px 0 #555;
            cursor: pointer; text-shadow: 1px 1px 0 #333; transition: background 0.1s;
        }
        .mc-btn:hover { background: #AAA; }
        .mc-btn:active { background: #777; box-shadow: inset -2px -2px 0 #CCC, inset 2px 2px 0 #555; }
        .mc-btn.primary { background: #5A9E2F; box-shadow: inset 2px 2px 0 #7BCF44, inset -2px -2px 0 #3B6B1E; }
        .mc-btn.primary:hover { background: #6AB33A; }

        .mc-btn.hint-btn { background: #B8860B; box-shadow: inset 2px 2px 0 #DAA520, inset -2px -2px 0 #8B6508; font-size: 10px; padding: 8px 14px; }
        .mc-btn.hint-btn:hover { background: #CC9A1E; }
        .mc-btn.hint-btn:disabled { background: #666; opacity: 0.5; cursor: default; }
        .mc-btn.hint-btn.hint-active { background: #DAA520; border-color: var(--gold); box-shadow: inset 2px 2px 0 #FFD700, inset -2px -2px 0 #8B6508, 0 0 8px rgba(218,165,32,0.4); }

        .feedback { text-align: center; min-height: 30px; margin-top: 15px; font-size: 11px; transition: opacity 0.3s; }
        .feedback.good { color: #17DD62; text-shadow: 1px 1px 0 #000; }
        .feedback.bad { color: #FF4444; text-shadow: 1px 1px 0 #000; }

        .hearts { display: flex; gap: 4px; align-items: center; }
        .heart { width: 20px; height: 18px; position: relative; }
        .heart svg { width: 100%; height: 100%; }
        .heart.lost svg { opacity: 0.25; }
        .heart.losing svg { animation: heart-break 0.3s ease; }
        @keyframes heart-break { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); opacity: 0.25; } }

        /* â•â•â• INVENTORY â•â•â• */
        .inventory { display: flex; justify-content: center; gap: 2px; margin-top: 12px; flex-wrap: wrap; }
        .inv-slot {
            width: 48px; height: 48px; background: #555; border: 2px solid #000;
            box-shadow: inset 1px 1px 0 #777, inset -1px -1px 0 #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; position: relative; cursor: default;
        }
        .inv-slot .count { position: absolute; bottom: 1px; right: 3px; font-size: 7px; color: #fff; text-shadow: 1px 1px 0 #000; }
        .inv-slot.active { border-color: #fff; box-shadow: inset 1px 1px 0 #aaa, inset -1px -1px 0 #555, 0 0 8px rgba(255,255,255,0.3); }
        .inv-slot.legendary { border-color: #FF00FF; box-shadow: inset 1px 1px 0 #FF88FF, inset -1px -1px 0 #880088, 0 0 12px rgba(255,0,255,0.4); animation: legendary-glow 2s ease infinite; }
        @keyframes legendary-glow { 0%,100% { box-shadow: inset 1px 1px 0 #FF88FF, inset -1px -1px 0 #880088, 0 0 8px rgba(255,0,255,0.3); } 50% { box-shadow: inset 1px 1px 0 #FF88FF, inset -1px -1px 0 #880088, 0 0 16px rgba(255,0,255,0.6); } }

        /* Tooltip */
        .inv-tooltip {
            display: none; position: absolute; bottom: 54px; left: 50%; transform: translateX(-50%);
            background: #1A0A2E; border: 2px solid #5500AA; padding: 6px 10px; z-index: 50;
            white-space: nowrap; pointer-events: none; min-width: 120px;
        }
        .inv-slot:hover .inv-tooltip { display: block; }
        .inv-tooltip .tt-name { font-size: 7px; color: #fff; margin-bottom: 3px; }
        .inv-tooltip .tt-name.rare { color: var(--diamond); }
        .inv-tooltip .tt-name.epic { color: #FF00FF; }
        .inv-tooltip .tt-name.legendary { color: var(--gold); }
        .inv-tooltip .tt-desc { font-size: 6px; color: #888; line-height: 1.6; }
        .inv-tooltip .tt-rarity { font-size: 6px; color: #666; margin-top: 2px; font-style: italic; }

        /* â•â•â• FLOATING SCORE â•â•â• */
        .float-score {
            position: fixed; pointer-events: none; z-index: 150;
            font-family: 'Press Start 2P', monospace; font-size: 14px;
            text-shadow: 2px 2px 0 #000;
            animation: float-up 1.2s ease-out forwards;
        }
        @keyframes float-up { 0% { opacity: 1; transform: translateY(0) scale(1); } 40% { transform: translateY(-30px) scale(1.2); } 100% { opacity: 0; transform: translateY(-80px) scale(0.8); } }

        /* â•â•â• SPEED INDICATOR â•â•â• */
        .speed-badge {
            display: inline-block; padding: 3px 8px; font-size: 8px; margin-top: 6px;
            border: 2px solid; text-align: center;
        }
        .speed-badge.lightning { color: #FCDB05; border-color: #FCDB05; background: rgba(252,219,5,0.15); }
        .speed-badge.fast { color: #5DECF5; border-color: #5DECF5; background: rgba(93,236,245,0.1); }
        .speed-badge.good { color: var(--emerald); border-color: var(--emerald); background: rgba(23,221,98,0.1); }
        .speed-badge.ok { color: #aaa; border-color: #777; background: rgba(255,255,255,0.05); }

        /* â•â•â• COMBO METER â•â•â• */
        .combo-container { text-align: center; min-height: 24px; margin-top: 6px; }
        .combo-text { font-size: 12px; text-shadow: 2px 2px 0 #000; }
        .combo-text.x2 { color: #5DECF5; }
        .combo-text.x3 { color: var(--gold); }
        .combo-text.x4 { color: #FF00FF; }
        .combo-text.x5 { color: #FF4444; animation: combo-pulse 0.5s ease infinite; }
        @keyframes combo-pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .combo-bar-bg { height: 6px; background: #333; border: 1px solid #555; margin-top: 3px; overflow: hidden; }
        .combo-bar-fill { height: 100%; transition: width 0.3s ease; }

        /* â•â•â• LOOT DROP ANIMATION â•â•â• */
        .loot-drop {
            position: fixed; pointer-events: none; z-index: 150;
            font-size: 28px;
            animation: loot-bounce 1s ease forwards;
        }
        @keyframes loot-bounce {
            0% { opacity: 0; transform: translateY(-40px) scale(0.3) rotate(-20deg); }
            30% { opacity: 1; transform: translateY(10px) scale(1.3) rotate(10deg); }
            50% { transform: translateY(-10px) scale(1) rotate(-5deg); }
            70% { transform: translateY(5px) scale(1.05) rotate(2deg); }
            85% { opacity: 1; transform: translateY(0) scale(1) rotate(0); }
            100% { opacity: 0; transform: translateY(-20px) scale(0.5); }
        }

        /* Difficulty */
        .difficulty { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin: 12px 0; }
        .diff-btn {
            font-family: 'Press Start 2P', monospace; font-size: 9px; padding: 8px 14px; cursor: pointer;
            background: #666; color: #aaa; border: 2px solid #000;
            box-shadow: inset 1px 1px 0 #888, inset -1px -1px 0 #444;
        }
        .diff-btn.active { background: #5A9E2F; color: #fff; box-shadow: inset 1px 1px 0 #7BCF44, inset -1px -1px 0 #3B6B1E; }
        .diff-btn:hover { background: #777; color: #ddd; }
        .diff-btn.active:hover { background: #6AB33A; color: #fff; }

        /* â•â•â• GOAL PANEL (current achievement target) â•â•â• */
        .goal-panel { display: flex; align-items: center; gap: 12px; padding: 10px 14px; position: relative; overflow: hidden; }
        .goal-panel.completed { animation: goal-flash 1.5s ease; }
        @keyframes goal-flash {
            0% { background: #C6C6C6; }
            15% { background: #FCDB05; box-shadow: inset 0 0 30px rgba(252,219,5,0.6); }
            40% { background: #FFE066; }
            100% { background: #C6C6C6; }
        }
        .goal-icon { font-size: 32px; min-width: 40px; text-align: center; animation: goal-bob 2.5s ease-in-out infinite; }
        @keyframes goal-bob { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .goal-icon.earned { animation: goal-earned 0.6s ease forwards; }
        @keyframes goal-earned { 0% { transform: scale(1); } 40% { transform: scale(1.5) rotate(10deg); } 70% { transform: scale(1.2) rotate(-5deg); } 100% { transform: scale(1) rotate(0); } }
        .goal-info { flex: 1; min-width: 0; }
        .goal-title { font-size: 9px; color: var(--gold); margin-bottom: 3px; text-shadow: 1px 1px 0 rgba(0,0,0,0.2); }
        .goal-desc { font-size: 7px; color: #555; margin-bottom: 6px; }
        .goal-progress-bg { height: 14px; background: #222; border: 2px solid #000; box-shadow: inset 1px 1px 0 #444; position: relative; overflow: hidden; }
        .goal-progress-fill { height: 100%; background: linear-gradient(180deg, var(--gold), #D4A800); transition: width 0.5s ease; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2); }
        .goal-progress-fill.full { background: linear-gradient(180deg, #7FFF00, #32CD32); }
        .goal-progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 7px; color: #fff; text-shadow: 1px 1px 0 #000; white-space: nowrap; }
        .goal-done-msg { text-align: center; font-size: 8px; color: var(--emerald); padding: 10px; }

        /* â•â•â• TROPHY SHELF â•â•â• */
        .trophy-shelf { display: flex; gap: 3px; flex-wrap: wrap; justify-content: center; margin-top: 6px; }
        .trophy-slot {
            width: 42px; height: 42px; background: #3A3A1A; border: 2px solid #555;
            box-shadow: inset 1px 1px 0 #666, inset -1px -1px 0 #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; position: relative; cursor: default;
        }
        .trophy-slot.empty { background: #444; opacity: 0.4; }
        .trophy-slot.empty::after { content: '?'; font-size: 14px; color: #666; }
        .trophy-slot.earned { border-color: var(--gold); box-shadow: inset 1px 1px 0 #FFE066, inset -1px -1px 0 #8B6508, 0 0 6px rgba(252,219,5,0.3); background: linear-gradient(180deg, #4A4A2A, #3A3A1A); }
        .trophy-slot.new-earned { animation: trophy-arrive 0.8s ease forwards; }
        @keyframes trophy-arrive {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.3) rotate(10deg); opacity: 1; }
            75% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        .trophy-tooltip {
            display: none; position: absolute; bottom: 48px; left: 50%; transform: translateX(-50%);
            background: #1A0A2E; border: 2px solid var(--gold); padding: 6px 10px; z-index: 50;
            white-space: nowrap; pointer-events: none; min-width: 110px; text-align: center;
        }
        .trophy-slot:hover .trophy-tooltip { display: block; }
        .trophy-tooltip .tt-name { font-size: 7px; color: var(--gold); margin-bottom: 2px; }
        .trophy-tooltip .tt-desc { font-size: 6px; color: #aaa; }

        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }
        .start-screen { text-align: center; }
        .start-screen .big-icon { font-size: 60px; margin: 20px 0; animation: bob 2s ease-in-out infinite; }
        @keyframes bob { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .start-screen p { font-size: 9px; color: #555; margin: 12px 0; line-height: 1.8; }

        .gameover-screen { text-align: center; }
        .gameover-screen h2 { font-size: 16px; color: #333; margin-bottom: 15px; }
        .gameover-screen .final-stats { font-size: 10px; color: #555; line-height: 2.2; }
        .gameover-screen .final-stats .val { color: var(--grass-dark); }

        .streak-display { text-align: center; font-size: 10px; color: #FF8800; text-shadow: 1px 1px 0 #000; min-height: 18px; margin-top: 6px; }

        .timer-section { margin-top: 8px; display: none; }
        .timer-section.visible { display: block; }
        .timer-bar-bg { height: 10px; background: #222; border: 2px solid #000; overflow: hidden; }
        .timer-bar-fill { height: 100%; background: linear-gradient(180deg, #FF6B00, #FF4400); transition: width 0.1s linear; }
        .timer-bar-fill.warning { background: linear-gradient(180deg, #FF0000, #CC0000); animation: pulse-red 0.5s ease infinite; }
        @keyframes pulse-red { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Hint system */
        .hint-row { display: flex; justify-content: center; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .visual-hint { margin-top: 16px; padding: 12px; background: #3A3A3A; border: 2px solid #555; display: none; text-align: center; }
        .visual-hint.show { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .hint-title { font-size: 8px; color: var(--gold); margin-bottom: 10px; }
        .hint-explanation { font-size: 8px; color: #ccc; margin-bottom: 10px; line-height: 1.8; }
        .block-grid { display: inline-grid; gap: 2px; margin: 8px auto; }
        .mc-block { width: 22px; height: 22px; border: 1px solid rgba(0,0,0,0.4); image-rendering: pixelated; transition: all 0.15s ease; }
        .mc-block.grass { background: linear-gradient(180deg, #5D9B2A 0%, #5D9B2A 30%, #8B6914 30%); }
        .mc-block.dirt { background: #8B6914; }
        .mc-block.stone { background: linear-gradient(135deg, #888 25%, #777 50%, #999 75%); }
        .mc-block.diamond { background: linear-gradient(135deg, #5DECF5 0%, #2BC4D8 50%, #5DECF5 100%); }
        .mc-block.gold { background: linear-gradient(135deg, #FCDB05 0%, #D4A800 50%, #FCDB05 100%); }
        .mc-block.wood { background: linear-gradient(0deg, #8B6914 0%, #BC9862 50%, #8B6914 100%); }
        .mc-block.highlight { animation: block-pop 0.3s ease forwards; box-shadow: 0 0 6px rgba(255,255,255,0.5); }
        @keyframes block-pop { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }
        .grid-label { font-size: 8px; color: #aaa; margin: 4px 0; }
        .grid-result { font-size: 12px; color: var(--emerald); margin-top: 8px; text-shadow: 1px 1px 0 #000; }
        .skip-count { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; margin: 10px 0; }
        .skip-num { background: #555; border: 2px solid #777; padding: 5px 8px; font-size: 10px; color: #ccc; min-width: 36px; text-align: center; }
        .skip-num.revealed { background: #2B6B1E; border-color: var(--emerald); color: #fff; animation: fadeIn 0.3s ease; }
        .skip-num.answer-num { background: #8B6508; border-color: var(--gold); color: var(--gold); font-size: 12px; }
        .skip-num.hidden { color: #555; }
        .nearby-facts { display: flex; flex-direction: column; gap: 4px; margin: 8px 0; align-items: center; }
        .nearby-fact { font-size: 9px; color: #aaa; padding: 3px 10px; }
        .nearby-fact.current { color: var(--gold); font-size: 11px; background: rgba(252,219,5,0.1); border: 1px solid rgba(252,219,5,0.3); }
        .nearby-fact .op { color: #888; }

        .wrong-explain { margin-top: 12px; padding: 12px; background: #2A1A1A; border: 2px solid #FF4444; display: none; text-align: center; }
        .wrong-explain.show { display: block; animation: fadeIn 0.4s ease; }
        .wrong-explain .explain-title { font-size: 8px; color: #FF8888; margin-bottom: 8px; }
        .wrong-explain .explain-text { font-size: 8px; color: #ccc; line-height: 1.8; margin-bottom: 8px; }

        .mistakes-review { margin-top: 16px; text-align: left; }
        .mistakes-review h3 { font-size: 10px; color: #FF8888; margin-bottom: 10px; text-align: center; }
        .mistake-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 4px; background: #555; border: 1px solid #777; font-size: 9px; gap: 8px; }
        .mistake-item .mistake-q { color: #fff; }
        .mistake-item .mistake-wrong { color: #FF6666; text-decoration: line-through; }
        .mistake-item .mistake-right { color: var(--emerald); }
        .mistake-item .mistake-count { color: var(--gold); font-size: 7px; }

        .hint-cost { font-size: 7px; color: #aaa; text-align: center; margin-top: 4px; }

        .mastery-section { margin-top: 16px; text-align: center; }
        .mastery-section h3 { font-size: 10px; color: var(--gold); margin-bottom: 10px; }
        .mastery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 4px; max-width: 400px; margin: 0 auto; }
        .mastery-cell { background: #444; border: 1px solid #666; padding: 4px; font-size: 7px; text-align: center; color: #ccc; }
        .mastery-cell .mastery-stars { color: var(--gold); font-size: 8px; }
        .mastery-cell.strong { background: #1A3A1A; border-color: var(--emerald); }
        .mastery-cell.weak { background: #3A1A1A; border-color: #FF4444; }

        /* Loot summary on game over */
        .loot-summary { margin-top: 12px; }
        .loot-summary h3 { font-size: 10px; color: var(--diamond); margin-bottom: 8px; }
        .loot-grid { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .loot-card { background: #444; border: 2px solid #666; padding: 6px 10px; text-align: center; min-width: 70px; }
        .loot-card.rare { border-color: var(--diamond); }
        .loot-card.epic { border-color: #FF00FF; }
        .loot-card.legendary { border-color: var(--gold); }
        .loot-card .loot-icon { font-size: 20px; }
        .loot-card .loot-name { font-size: 6px; color: #ccc; margin-top: 3px; }
        .loot-card .loot-qty { font-size: 7px; color: var(--gold); }

        @media (max-width: 500px) {
            .title h1 { font-size: 13px; }
            .question-text { font-size: 22px; }
            .answer-input { font-size: 18px; width: 110px; }
            .stat { font-size: 8px; }
            .inv-slot { width: 40px; height: 40px; font-size: 18px; }
            .mc-btn { font-size: 10px; padding: 8px 14px; }
            .mc-block { width: 16px; height: 16px; }
        }
    </style>
</head>
<body>

<div class="clouds"><div class="cloud cloud-1"></div><div class="cloud cloud-2"></div><div class="cloud cloud-3"></div></div>
<div class="particles" id="particles"></div>


<div class="game-container">
    <div class="title"><h1>â›ï¸ <span class="green">TABLICZKA</span> <span class="brown">MNOÅ»ENIA</span> â›ï¸<br>Minecraft Edition</h1></div>

    <!-- START -->
    <div id="startScreen" class="screen active">
        <div class="mc-panel start-screen">
            <div class="big-icon">â›ï¸</div>
            <p>
                RozwiÄ…zuj zadania z tabliczki mnoÅ¼enia,<br>
                zbieraj Minecraftowe przedmioty!<br><br>
                âš¡ Im szybciej odpowiesz, tym wiÄ™cej punktÃ³w!<br>
                ğŸ”¥ Buduj seriÄ™ combo dla mnoÅ¼nika!<br>
                ğŸ“– Nie wiesz? UÅ¼yj podpowiedzi!
            </p>
            <div style="margin: 16px 0;">
                <div style="font-size: 9px; color: #555; margin-bottom: 8px;">WYBIERZ POZIOM:</div>
                <div class="difficulty">
                    <button class="diff-btn active" onclick="setDifficulty('easy', this)">ğŸ˜Š Åatwy<br><span style="font-size:7px;">2-5</span></button>
                    <button class="diff-btn" onclick="setDifficulty('medium', this)">ğŸ˜ Åšredni<br><span style="font-size:7px;">2-10</span></button>
                    <button class="diff-btn" onclick="setDifficulty('hard', this)">ğŸ’€ Trudny<br><span style="font-size:7px;">2-12 + czas</span></button>
                </div>
            </div>
            <button class="mc-btn primary" onclick="startGame()" style="font-size: 14px; padding: 14px 30px;">â–¶ GRAJ!</button>
        </div>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="screen">
        <div class="mc-panel">
            <div class="stats-bar">
                <div class="stat">ğŸ’ <span id="score">0</span></div>
                <div class="stat">âœ… <span id="correct">0</span>/<span id="total">0</span></div>
                <div class="hearts" id="hearts"></div>
            </div>
            <div class="xp-section">
                <div class="xp-label"><span>DOÅšWIADCZENIE</span><span id="xpText">0 / 100 XP</span></div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpBar" style="width:0%"></div><div class="xp-bar-text" id="xpBarText">Poziom 1</div></div>
            </div>
            <div class="timer-section" id="timerSection"><div class="timer-bar-bg"><div class="timer-bar-fill" id="timerBar" style="width:100%"></div></div></div>
            <div class="combo-container" id="comboContainer"></div>
        </div>

        <div class="mc-panel" id="goalPanel">
            <div style="font-size: 8px; color: #555; text-align: center; margin-bottom: 6px;">ğŸ¯ NASTÄ˜PNA NAGRODA ğŸ¯</div>
            <div class="goal-panel" id="goalContent"></div>
        </div>

        <div class="mc-panel">
            <div class="question-area">
                <div class="question-text" id="question">? Ã— ? = ?</div>
                <div class="answer-row">
                    <input type="number" class="answer-input" id="answerInput" autocomplete="off" placeholder="?" onkeydown="if(event.key==='Enter') checkAnswer()">
                    <button class="mc-btn primary" onclick="checkAnswer()">OK</button>
                </div>
                <div class="hint-row">
                    <button class="mc-btn hint-btn" id="hintBlocksBtn" onclick="showHint('blocks')">ğŸ§± Bloczki</button>
                    <button class="mc-btn hint-btn" id="hintSkipBtn" onclick="showHint('skip')">ğŸ”¢ Licz co...</button>
                    <button class="mc-btn hint-btn" id="hintNearbyBtn" onclick="showHint('nearby')">ğŸ“– Blisko!</button>
                </div>
                <div class="hint-cost" id="hintCost">PodpowiedÅº = mniej ğŸ’, ale wiÄ™cej wiedzy!</div>
                <div class="feedback" id="feedback"></div>
                <div class="visual-hint" id="visualHint"></div>
                <div class="wrong-explain" id="wrongExplain"></div>
                <div id="continueRow" style="display:none; margin-top: 12px;">
                    <button class="mc-btn primary" id="continueBtn" onclick="continueAfterWrong()" style="font-size: 11px; padding: 10px 24px;">â–¶ ROZUMIEM, DALEJ!</button>
                </div>
            </div>
        </div>

        <div class="mc-panel">
            <div style="font-size: 8px; color: #555; text-align: center; margin-bottom: 6px;">ğŸ† TROFEA ğŸ†</div>
            <div class="trophy-shelf" id="trophyShelf"></div>
        </div>

        <div class="mc-panel">
            <div style="font-size: 8px; color: #555; text-align: center; margin-bottom: 6px;">âš”ï¸ EKWIPUNEK âš”ï¸</div>
            <div class="inventory" id="inventory"></div>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameoverScreen" class="screen">
        <div class="mc-panel gameover-screen">
            <h2>ğŸ KONIEC GRY!</h2>
            <div class="final-stats" id="finalStats"></div>
            <div class="loot-summary" id="lootSummary"></div>
            <div class="mistakes-review" id="mistakesReview"></div>
            <div class="mastery-section" id="masterySection"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="mc-btn primary" onclick="startGame()">ğŸ”„ JESZCZE RAZ</button>
                <button class="mc-btn" onclick="practiceWeakSpots()">ğŸ¯ Ä†WICZ BÅÄ˜DY</button>
                <button class="mc-btn" onclick="showScreen('startScreen')">ğŸ  MENU</button>
            </div>
        </div>
    </div>
</div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Minecraft Items Database
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const MC_ITEMS = {
        // Common drops
        cobblestone:  { icon: 'ğŸª¨', name: 'Cobblestone',      rarity: 'common',    desc: 'Podstawowy blok' },
        wood:         { icon: 'ğŸªµ', name: 'Drewno',           rarity: 'common',    desc: 'Zawsze siÄ™ przyda' },
        coal:         { icon: 'ï¿½ite', name: 'WÄ™giel',          rarity: 'common',    desc: 'Dobry na pochodnie' },
        iron:         { icon: 'ğŸ”©', name: 'Å»elazo',           rarity: 'common',    desc: 'Mocny metal' },
        apple:        { icon: 'ğŸ', name: 'JabÅ‚ko',           rarity: 'common',    desc: '+1 â¤ï¸ Å¼ycia!' },
        bread:        { icon: 'ğŸ', name: 'Chleb',            rarity: 'common',    desc: 'Energia na dalszÄ… grÄ™' },
        // Uncommon
        gold_ingot:   { icon: 'ğŸ¥‡', name: 'Sztabka zÅ‚ota',    rarity: 'uncommon',  desc: 'LÅ›niÄ…ce zÅ‚oto' },
        lapis:        { icon: 'ğŸ”µ', name: 'Lapis Lazuli',     rarity: 'uncommon',  desc: 'Do zaklÄ™Ä‡' },
        redstone:     { icon: 'ğŸ”´', name: 'Redstone',         rarity: 'uncommon',  desc: 'Moc elektryczna!' },
        bow:          { icon: 'ğŸ¹', name: 'Åuk',              rarity: 'uncommon',  desc: 'BroÅ„ na dystans' },
        // Rare
        diamond:      { icon: 'ğŸ’', name: 'Diament',          rarity: 'rare',      desc: 'Najcenniejszy krysztaÅ‚!' },
        emerald:      { icon: 'ğŸ’š', name: 'Szmaragd',         rarity: 'rare',      desc: 'Waluta u wieÅ›niakÃ³w' },
        ench_book:    { icon: 'ğŸ“–', name: 'KsiÄ™ga zaklÄ™Ä‡',    rarity: 'rare',      desc: 'Magiczna wiedza' },
        golden_apple: { icon: 'ğŸ', name: 'ZÅ‚ote jabÅ‚ko',     rarity: 'rare',      desc: 'PeÅ‚ne Å¼ycie!' },
        // Epic
        diamond_sword:{ icon: 'âš”ï¸', name: 'Diamentowy miecz', rarity: 'epic',      desc: 'Legendarny orÄ™Å¼!' },
        diamond_pick: { icon: 'â›ï¸', name: 'Diamentowy kilof',  rarity: 'epic',      desc: 'Wykopie wszystko!' },
        elytra:       { icon: 'ğŸª½', name: 'Elytra',           rarity: 'epic',      desc: 'MoÅ¼esz lataÄ‡!' },
        trident:      { icon: 'ğŸ”±', name: 'TrÃ³jzÄ…b',          rarity: 'epic',      desc: 'BroÅ„ z oceanu!' },
        // Legendary
        nether_star:  { icon: 'â­', name: 'Gwiazda Netheru',  rarity: 'legendary', desc: 'Z Withera! Ultra rzadka!' },
        dragon_egg:   { icon: 'ğŸ¥š', name: 'Smocze jajo',      rarity: 'legendary', desc: 'Jedyne w Å›wiecie!' },
        totem:        { icon: 'ğŸ—¿', name: 'Totem nieÅ›miertelnoÅ›ci', rarity: 'legendary', desc: 'Chroni przed Å›mierciÄ…!' },
        beacon:       { icon: 'ğŸ”¦', name: 'Beacon',           rarity: 'legendary', desc: 'Åšwieci na caÅ‚y Å›wiat!' },
    };

    // Loot tables based on speed and streak
    const LOOT_TABLES = {
        lightning: { // < 2s
            common: 0.05, uncommon: 0.15, rare: 0.40, epic: 0.30, legendary: 0.10
        },
        fast: { // < 4s
            common: 0.10, uncommon: 0.30, rare: 0.35, epic: 0.20, legendary: 0.05
        },
        good: { // < 8s
            common: 0.25, uncommon: 0.35, rare: 0.25, epic: 0.12, legendary: 0.03
        },
        ok: { // >= 8s or hint
            common: 0.50, uncommon: 0.30, rare: 0.15, epic: 0.04, legendary: 0.01
        }
    };

    const SPEED_LABELS = {
        lightning: { label: 'âš¡ BÅYSKAWICA!', cls: 'lightning', points: 5 },
        fast:      { label: 'ğŸƒ Szybko!',      cls: 'fast',      points: 3 },
        good:      { label: 'ğŸ‘ Dobrze',        cls: 'good',      points: 2 },
        ok:        { label: 'ğŸ¢ Powoli...',     cls: 'ok',        points: 1 },
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Game State
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let state = {
        difficulty: 'easy', score: 0, xp: 0, level: 1, xpToNext: 100,
        correct: 0, total: 0, lives: 5, maxLives: 5,
        streak: 0, bestStreak: 0, combo: 1,
        a: 0, b: 0, answer: 0,
        timerInterval: null, timeLeft: 0, timerMax: 15,
        achievements: new Set(), playing: false,
        hintUsed: false, hintsUsedTotal: 0,
        // Timing
        questionStartTime: 0,
        // Items
        inventory: {}, // itemKey -> count
        lootLog: [],   // [{itemKey, rarity}] for game-over summary
        // Learning
        mistakes: [], mistakeMap: {}, masteryMap: {},
        questionQueue: [], practiceMode: false, questionHistory: [],
        freshPool: [], askedSet: new Set(),
    };

    const diffSettings = {
        easy:   { min: 2, max: 5,  timer: false, lives: 5 },
        medium: { min: 2, max: 10, timer: false, lives: 5 },
        hard:   { min: 2, max: 12, timer: true,  lives: 3, time: 15 }
    };

    const blockTypes = ['grass', 'dirt', 'stone', 'diamond', 'gold', 'wood'];

    const achievementList = [
        { id: 'first',      check: s => s.correct >= 1,          icon: 'â­', title: 'Pierwszy krok!',      desc: 'Pierwsza poprawna odpowiedÅº',  progress: s => ({ cur: s.correct, max: 1, label: 'Poprawne' }) },
        { id: 'streak5',    check: s => s.streak >= 5,           icon: 'ğŸ”¥', title: 'W ogniu!',            desc: 'Seria 5 poprawnych z rzÄ™du',   progress: s => ({ cur: s.streak, max: 5, label: 'Seria' }) },
        { id: 'dia10',      check: s => s.score >= 30,           icon: 'ğŸ’', title: 'GÃ³rnik diamentÃ³w!',   desc: 'ZdobÄ…dÅº 30 punktÃ³w',           progress: s => ({ cur: s.score, max: 30, label: 'Punkty' }) },
        { id: 'hint_learn', check: s => s.hintsUsedTotal >= 5,   icon: 'ğŸ“–', title: 'Badacz!',             desc: 'UÅ¼yj 5 podpowiedzi',           progress: s => ({ cur: s.hintsUsedTotal, max: 5, label: 'Podpowiedzi' }) },
        { id: 'perfect10',  check: s => s.correct >= 10 && s.correct === s.total, icon: 'ğŸ¯', title: 'Perfekcja!', desc: '10 poprawnych bez bÅ‚Ä™du', progress: s => ({ cur: s.correct === s.total ? s.correct : 0, max: 10, label: 'Bez bÅ‚Ä™du' }) },
        { id: 'streak10',   check: s => s.streak >= 10,          icon: 'âš¡', title: 'Niepokonany!',        desc: 'Seria 10 poprawnych z rzÄ™du',  progress: s => ({ cur: s.streak, max: 10, label: 'Seria' }) },
        { id: 'comeback',   check: s => s.streak >= 3 && s.lives === 1, icon: 'ğŸ’ª', title: 'Nie poddajÄ™ siÄ™!', desc: 'Seria 3 z ostatnim Å¼yciem', progress: s => ({ cur: s.lives === 1 ? s.streak : 0, max: 3, label: 'Seria (1â¤ï¸)' }) },
        { id: 'lightning5',  check: s => s._lightningCount >= 5,  icon: 'âš¡', title: 'PrÄ™dkoÅ›Ä‡ Å›wiatÅ‚a!',  desc: '5 odpowiedzi poniÅ¼ej 2s',      progress: s => ({ cur: s._lightningCount || 0, max: 5, label: 'BÅ‚yskawice' }) },
        { id: 'dia50',      check: s => s.score >= 100,          icon: 'ğŸ’', title: 'Koparka diamentowa!', desc: 'ZdobÄ…dÅº 100 punktÃ³w',          progress: s => ({ cur: s.score, max: 100, label: 'Punkty' }) },
        { id: 'combo_x5',   check: s => s.combo >= 5,            icon: 'ğŸ’¥', title: 'MEGA COMBO!',         desc: 'OsiÄ…gnij combo Ã—5',            progress: s => ({ cur: s.combo, max: 5, label: 'Combo' }) },
        { id: 'lvl5',       check: s => s.level >= 5,            icon: 'ğŸ†', title: 'Mistrz matematyki!',  desc: 'OsiÄ…gnij poziom 5',            progress: s => ({ cur: s.level, max: 5, label: 'Poziom' }) },
        { id: 'legendary',  check: s => s._hasLegendary,         icon: 'ğŸ¥š', title: 'Legendarny Å‚up!',    desc: 'ZdobÄ…dÅº legendarny przedmiot', progress: s => ({ cur: s._hasLegendary ? 1 : 0, max: 1, label: 'Legendarny' }) },
        { id: 'lvl10',      check: s => s.level >= 10,           icon: 'ğŸ‘‘', title: 'Legenda!',            desc: 'OsiÄ…gnij poziom 10',           progress: s => ({ cur: s.level, max: 10, label: 'Poziom' }) },
    ];

    const goodMessages = ['Åšwietnie! â›ï¸','Brawo! ğŸ’','Dobrze! âœ…','Super! ğŸŒŸ','Genialnie! ğŸ”¥','Tak trzymaj! ğŸ’ª','Mistrz! ğŸ‘‘','Niesamowite! âš¡','Fantastycznie! ğŸ‰','Wow! ğŸ†'];
    const badMessages = ['SprÃ³buj ponownie!','Prawie!','Nie poddawaj siÄ™!','Ä†wicz dalej! ğŸ’ª'];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Speed & Combo System
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getSpeedTier(ms) {
        if (ms < 2000) return 'lightning';
        if (ms < 4000) return 'fast';
        if (ms < 8000) return 'good';
        return 'ok';
    }

    function updateCombo(correct) {
        if (correct) {
            state.streak++;
            if (state.streak > state.bestStreak) state.bestStreak = state.streak;
            // Combo grows every 3 correct, max 5
            state.combo = Math.min(5, 1 + Math.floor(state.streak / 3));
        } else {
            state.streak = 0;
            state.combo = 1;
        }
        renderCombo();
    }

    function renderCombo() {
        const el = document.getElementById('comboContainer');
        if (state.combo >= 2) {
            const cls = state.combo >= 5 ? 'x5' : state.combo >= 4 ? 'x4' : state.combo >= 3 ? 'x3' : 'x2';
            const pct = ((state.streak % 3) / 3) * 100;
            const nextCombo = state.combo < 5 ? ` â†’ Ã—${state.combo + 1}` : ' MAX!';
            el.innerHTML = `
                <div class="combo-text ${cls}">ğŸ”¥ COMBO Ã—${state.combo} ğŸ”¥</div>
                <div class="combo-bar-bg"><div class="combo-bar-fill" style="width:${state.combo >= 5 ? 100 : pct}%;background:${
                    state.combo >= 5 ? '#FF4444' : state.combo >= 4 ? '#FF00FF' : state.combo >= 3 ? '#FCDB05' : '#5DECF5'
                }"></div></div>
            `;
        } else if (state.streak > 0) {
            const pct = (state.streak / 3) * 100;
            el.innerHTML = `
                <div style="font-size:8px;color:#888;">seria: ${state.streak} (combo za ${3 - state.streak}...)</div>
                <div class="combo-bar-bg"><div class="combo-bar-fill" style="width:${pct}%;background:#888"></div></div>
            `;
        } else {
            el.innerHTML = '';
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Loot System
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function rollLoot(speedTier) {
        const table = LOOT_TABLES[speedTier];
        const roll = Math.random();
        let rarity;
        let cumul = 0;
        for (const [r, chance] of Object.entries(table)) {
            cumul += chance;
            if (roll <= cumul) { rarity = r; break; }
        }
        if (!rarity) rarity = 'common';

        // Combo bonus: extra roll chance for better rarity
        if (state.combo >= 3 && rarity === 'common') rarity = 'uncommon';
        if (state.combo >= 5 && rarity === 'uncommon' && Math.random() < 0.5) rarity = 'rare';

        // Pick random item of that rarity
        const candidates = Object.entries(MC_ITEMS).filter(([_, v]) => v.rarity === rarity);
        const [itemKey, item] = candidates[Math.floor(Math.random() * candidates.length)];

        // Add to inventory
        state.inventory[itemKey] = (state.inventory[itemKey] || 0) + 1;
        state.lootLog.push({ itemKey, rarity });

        if (rarity === 'legendary') state._hasLegendary = true;

        return { itemKey, item };
    }

    function spawnLootDrop(item) {
        const el = document.createElement('div');
        el.className = 'loot-drop';
        el.textContent = item.icon;
        el.style.left = (window.innerWidth / 2 + (Math.random() - 0.5) * 150) + 'px';
        el.style.top = (window.innerHeight / 2 - 50) + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function spawnFloatScore(points, speedTier, x, y) {
        const el = document.createElement('div');
        el.className = 'float-score';
        const colors = { lightning: '#FCDB05', fast: '#5DECF5', good: '#17DD62', ok: '#aaa' };
        el.style.color = colors[speedTier];
        el.textContent = `+${points}`;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1200);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Core Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function setDifficulty(diff, btn) {
        state.difficulty = diff;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startGame() {
        const settings = diffSettings[state.difficulty];
        Object.assign(state, {
            score: 0, xp: 0, level: 1, xpToNext: 100,
            correct: 0, total: 0,
            lives: settings.lives, maxLives: settings.lives,
            streak: 0, bestStreak: 0, combo: 1,
            playing: true, hintUsed: false, hintsUsedTotal: 0,
            inventory: {}, lootLog: [],
            mistakes: [], mistakeMap: {}, masteryMap: {},
            questionQueue: [], practiceMode: false, questionHistory: [],
            freshPool: [], askedSet: new Set(),
            _lightningCount: 0, _hasLegendary: false, _newTrophies: null,
        });
        buildFreshPool();

        if (settings.timer) {
            state.timerMax = settings.time;
            document.getElementById('timerSection').classList.add('visible');
        } else {
            document.getElementById('timerSection').classList.remove('visible');
        }

        updateUI();
        showScreen('gameScreen');
        nextQuestion();
    }

    function buildFreshPool() {
        const settings = diffSettings[state.difficulty];
        state.freshPool = [];
        for (let a = settings.min; a <= settings.max; a++) {
            for (let b = a; b <= settings.max; b++) {
                state.freshPool.push({ a, b });
            }
        }
        shuffle(state.freshPool);
        state.askedSet = new Set();
    }

    function pullFromPool() {
        if (state.freshPool.length > 0) {
            const q = state.freshPool.shift();
            return Math.random() < 0.5 ? { a: q.a, b: q.b } : { a: q.b, b: q.a };
        }
        buildFreshPool();
        if (state.freshPool.length > 0) {
            const q = state.freshPool.shift();
            return Math.random() < 0.5 ? { a: q.a, b: q.b } : { a: q.b, b: q.a };
        }
        const s = diffSettings[state.difficulty];
        return { a: randInt(s.min, s.max), b: randInt(s.min, s.max) };
    }

    function practiceWeakSpots() {
        const weakPairs = Object.entries(state.mistakeMap).filter(([_, c]) => c > 0);
        if (weakPairs.length === 0) { startGame(); return; }

        const settings = diffSettings[state.difficulty];
        Object.assign(state, {
            score: 0, xp: 0, level: 1, xpToNext: 100,
            correct: 0, total: 0,
            lives: Math.max(settings.lives, 5), maxLives: Math.max(settings.lives, 5),
            streak: 0, bestStreak: 0, combo: 1,
            playing: true, hintUsed: false,
            practiceMode: true, questionHistory: [],
            inventory: {}, lootLog: [],
            _lightningCount: 0, _hasLegendary: false, _newTrophies: null,
        });

        state.questionQueue = [];
        for (const [key, count] of Object.entries(state.mistakeMap)) {
            if (count > 0) {
                const [a, b] = key.split('Ã—').map(Number);
                for (let i = 0; i < Math.min(count + 1, 4); i++) {
                    state.questionQueue.push({ a, b });
                }
            }
        }
        shuffle(state.questionQueue);

        document.getElementById('timerSection').classList.remove('visible');
        updateUI(); showScreen('gameScreen');
        showAchievement('ğŸ¯', 'Tryb Ä‡wiczeÅ„!', 'Powtarzamy trudne zadania');
        nextQuestion();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Question Selection
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function nextQuestion() {
        hideHints();
        state.hintUsed = false;

        let a, b;
        if (state.practiceMode && state.questionQueue.length > 0) {
            const q = state.questionQueue.shift();
            a = q.a; b = q.b;
        } else if (!state.practiceMode && state.total > 0 && Math.random() < getRepeatChance()) {
            const weak = getWeakestQuestion();
            if (weak) { a = weak.a; b = weak.b; }
        }
        if (!a || !b) { const q = pullFromPool(); a = q.a; b = q.b; }

        state.a = a; state.b = b; state.answer = a * b;
        state.askedSet.add(masteryKey(a, b));
        state.questionHistory.push(`${a}Ã—${b}`);
        if (state.questionHistory.length > 5) state.questionHistory.shift();

        const key = masteryKey(a, b);
        if (!state.masteryMap[key]) state.masteryMap[key] = { correct: 0, total: 0, streak: 0 };

        document.getElementById('question').textContent = `${a} Ã— ${b} = ?`;
        const input = document.getElementById('answerInput');
        input.value = ''; input.className = 'answer-input'; input.focus();
        document.getElementById('feedback').textContent = '';
        document.getElementById('hintCost').textContent = 'PodpowiedÅº = mniej ğŸ’, ale wiÄ™cej wiedzy!';

        // Start measuring answer time
        state.questionStartTime = Date.now();

        const settings = diffSettings[state.difficulty];
        if (settings.timer) startTimer();
        if (state.practiceMode && state.questionQueue.length === 0) state.practiceMode = false;
    }

    function getRepeatChance() {
        const totalMistakes = Object.values(state.mistakeMap).reduce((s, v) => s + v, 0);
        return Math.min(0.6, 0.2 + totalMistakes * 0.05);
    }

    function getWeakestQuestion() {
        const entries = Object.entries(state.mistakeMap).filter(([_, c]) => c > 0);
        if (entries.length === 0) return null;
        const totalWeight = entries.reduce((s, [_, c]) => s + c, 0);
        let r = Math.random() * totalWeight;
        for (const [key, count] of entries) {
            r -= count;
            if (r <= 0) {
                const [a, b] = key.split('Ã—').map(Number);
                if (!isRecentQuestion(a, b)) return { a, b };
            }
        }
        const [key] = entries[0];
        const [a, b] = key.split('Ã—').map(Number);
        return { a, b };
    }

    function isRecentQuestion(a, b) {
        return state.questionHistory.includes(`${a}Ã—${b}`) || state.questionHistory.includes(`${b}Ã—${a}`);
    }

    function masteryKey(a, b) { return `${Math.min(a,b)}Ã—${Math.max(a,b)}`; }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Hint System
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showHint(type) {
        if (!state.playing) return;
        if (!state.hintUsed) { state.hintUsed = true; state.hintsUsedTotal++; }
        document.querySelectorAll('.hint-btn').forEach(b => b.classList.remove('hint-active'));
        const btnMap = { blocks: 'hintBlocksBtn', skip: 'hintSkipBtn', nearby: 'hintNearbyBtn' };
        document.getElementById(btnMap[type]).classList.add('hint-active');
        const hint = document.getElementById('visualHint');
        hint.innerHTML = ''; hint.classList.add('show');
        document.getElementById('hintCost').textContent = 'ğŸ“– PodpowiedÅº uÅ¼yta (mniej punktÃ³w) â€” klikaj inne aby porÃ³wnaÄ‡!';
        if (type === 'blocks') buildBlocksHint(hint);
        else if (type === 'skip') buildSkipCountHint(hint);
        else if (type === 'nearby') buildNearbyHint(hint);
        checkAchievements();
    }

    function buildBlocksHint(container) {
        const a = state.a, b = state.b;
        const bt = blockTypes[Math.floor(Math.random() * blockTypes.length)];
        container.innerHTML = `<div class="hint-title">ğŸ§± WIZUALIZACJA: ${a} Ã— ${b}</div><div class="hint-explanation">${a} Ã— ${b} oznacza: ${a} rzÄ™dÃ³w po ${b} bloczkÃ³w</div><div class="grid-label">${a} rzÄ™dy â†“ Ã— ${b} kolumny â†’</div><div id="blockGrid" class="block-grid" style="grid-template-columns: repeat(${b}, 22px);"></div><div class="grid-result" id="gridResult"></div>`;
        const grid = document.getElementById('blockGrid');
        const total = a * b; let count = 0;
        for (let i = 0; i < a; i++) { for (let j = 0; j < b; j++) { count++;
            const block = document.createElement('div'); block.className = `mc-block ${bt}`;
            const delay = count * 60, cc = count; block.style.opacity = '0'; grid.appendChild(block);
            setTimeout(() => { block.classList.add('highlight'); block.style.opacity = '1';
                document.getElementById('gridResult').textContent = cc === total ? `= ${total} bloczkÃ³w! âœ…` : `${cc} / ${total}...`; }, delay);
        }}
    }

    function buildSkipCountHint(container) {
        const a = state.a, b = state.b;
        container.innerHTML = `<div class="hint-title">ğŸ”¢ LICZENIE CO ${b}</div><div class="hint-explanation">${a} Ã— ${b} = dodaj ${b} do siebie ${a} razy:</div><div class="skip-count" id="skipCount"></div><div class="grid-result" id="skipResult"></div>`;
        const sd = document.getElementById('skipCount');
        for (let i = 1; i <= a; i++) { const n = document.createElement('div'); n.className = 'skip-num hidden'; n.textContent = i * b; sd.appendChild(n); }
        for (let i = 1; i <= a; i++) { setTimeout(() => { const el = sd.children[i-1]; el.classList.remove('hidden'); el.classList.add(i === a ? 'answer-num' : 'revealed');
            const l = []; for (let j = 1; j <= i; j++) l.push(b);
            document.getElementById('skipResult').textContent = i === a ? `${l.join(' + ')} = ${i*b} âœ…` : `${l.join(' + ')} = ${i*b}`; }, i * 400); }
    }

    function buildNearbyHint(container) {
        const a = state.a, b = state.b;
        const facts = [];
        if (a > 1) facts.push({ a: a-1, b, result: (a-1)*b, current: false });
        facts.push({ a, b, result: a*b, current: true });
        if (a <= 12) facts.push({ a: a+1, b, result: (a+1)*b, current: false });
        container.innerHTML = `<div class="hint-title">ğŸ“– SÄ„SIEDNIE DZIAÅANIA</div><div class="hint-explanation">JeÅ›li znasz sÄ…siednie mnoÅ¼enia,<br>wystarczy dodaÄ‡ lub odjÄ…Ä‡ ${b}!</div><div class="nearby-facts" id="nearbyFacts"></div><div class="hint-explanation" style="margin-top:8px;color:var(--diamond);">${a > 1 ? `${a-1} Ã— ${b} = ${(a-1)*b}, wiÄ™c dodaj ${b}...` : `1 Ã— ${b} = ${b}, zacznij od tego!`}</div>`;
        const fd = document.getElementById('nearbyFacts');
        facts.forEach((f, i) => { setTimeout(() => { const el = document.createElement('div'); el.className = 'nearby-fact' + (f.current ? ' current' : '');
            el.innerHTML = f.current ? `${f.a} Ã— ${f.b} <span class="op">=</span> <strong>?</strong>` : `${f.a} Ã— ${f.b} <span class="op">=</span> ${f.result}`;
            fd.appendChild(el); }, i * 300); });
    }

    function showWrongHint(type) {
        const hint = document.getElementById('visualHint'); hint.innerHTML = ''; hint.classList.add('show');
        if (type === 'blocks') buildBlocksHint(hint); else if (type === 'skip') buildSkipCountHint(hint); else if (type === 'nearby') buildNearbyHint(hint);
    }

    function hideHints() {
        document.getElementById('visualHint').classList.remove('show');
        document.getElementById('visualHint').innerHTML = '';
        document.getElementById('wrongExplain').classList.remove('show');
        document.getElementById('wrongExplain').innerHTML = '';
        document.getElementById('continueRow').style.display = 'none';
        document.querySelectorAll('.hint-btn').forEach(b => { b.classList.remove('hint-active'); b.disabled = false; });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Answer Handling
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function startTimer() {
        clearInterval(state.timerInterval); state.timeLeft = state.timerMax; updateTimerBar();
        state.timerInterval = setInterval(() => {
            state.timeLeft -= 0.1;
            if (state.timeLeft <= 0) { state.timeLeft = 0; clearInterval(state.timerInterval); handleWrong(); }
            updateTimerBar();
        }, 100);
    }

    function updateTimerBar() {
        const pct = (state.timeLeft / state.timerMax) * 100;
        const bar = document.getElementById('timerBar');
        bar.style.width = pct + '%';
        bar.className = 'timer-bar-fill' + (pct < 30 ? ' warning' : '');
    }

    function checkAnswer() {
        if (!state.playing) return;
        const input = document.getElementById('answerInput');
        const val = parseInt(input.value);
        if (isNaN(val)) return;
        clearInterval(state.timerInterval);
        state.total++;
        const key = masteryKey(state.a, state.b);
        state.masteryMap[key].total++;
        if (val === state.answer) handleCorrect(input);
        else handleWrong(input, val);
    }

    function handleCorrect(input) {
        if (input) input.className = 'answer-input correct';
        state.correct++;

        const key = masteryKey(state.a, state.b);
        state.masteryMap[key].correct++;
        state.masteryMap[key].streak++;

        const mKey = `${state.a}Ã—${state.b}`;
        if (state.mistakeMap[mKey] && state.mistakeMap[mKey] > 0) state.mistakeMap[mKey]--;

        // Speed calculation
        const answerTime = Date.now() - state.questionStartTime;
        const speedTier = state.hintUsed ? 'ok' : getSpeedTier(answerTime);
        const speedInfo = SPEED_LABELS[speedTier];

        if (speedTier === 'lightning') state._lightningCount = (state._lightningCount || 0) + 1;

        // Update combo
        updateCombo(true);

        // Points: speed Ã— combo
        const basePoints = speedInfo.points;
        const points = basePoints * state.combo;
        state.score += points;

        // XP
        const xpGain = state.hintUsed ? 8 : (10 + basePoints * 3 + state.combo * 2);
        state.xp += xpGain;
        while (state.xp >= state.xpToNext) {
            state.xp -= state.xpToNext;
            state.level++;
            state.xpToNext = Math.floor(100 * Math.pow(1.3, state.level - 1));
            showAchievement('â¬†ï¸', 'Nowy poziom!', `OsiÄ…gnÄ…Å‚eÅ› poziom ${state.level}!`);
            grantLevelReward();
        }

        // Loot drop!
        const loot = rollLoot(speedTier);
        spawnLootDrop(loot.item);

        // Floating score
        spawnFloatScore(points, speedTier, window.innerWidth / 2 - 20, window.innerHeight / 2 - 80);

        // Feedback
        const fb = document.getElementById('feedback');
        fb.className = 'feedback good';
        let msg;
        if (state.hintUsed) {
            msg = `Dobrze! ZapamiÄ™taj: ${state.a}Ã—${state.b}=${state.answer} ğŸ“–`;
        } else {
            msg = `${speedInfo.label} +${points}ğŸ’`;
            if (state.combo >= 2) msg += ` (Ã—${state.combo} combo!)`;
            msg += ` â†’ ${loot.item.icon} ${loot.item.name}`;
        }
        fb.textContent = msg;

        spawnParticles(speedTier === 'lightning' ? 16 : speedTier === 'fast' ? 10 : 6,
            ['#5DECF5', '#17DD62', '#FCDB05', '#FF00FF']);

        checkAchievements();
        updateUI();
        setTimeout(nextQuestion, state.hintUsed ? 2500 : 1000);
    }

    function handleWrong(input, wrongVal) {
        if (input) input.className = 'answer-input wrong';

        const key = masteryKey(state.a, state.b);
        state.masteryMap[key].streak = 0;

        const mKey = `${state.a}Ã—${state.b}`;
        state.mistakeMap[mKey] = (state.mistakeMap[mKey] || 0) + 2;

        const existing = state.mistakes.find(m => m.a === state.a && m.b === state.b);
        if (existing) { existing.count++; existing.lastWrong = wrongVal; }
        else { state.mistakes.push({ a: state.a, b: state.b, correctAnswer: state.answer, lastWrong: wrongVal, count: 1 }); }

        updateCombo(false);
        state.lives--;

        const hearts = document.querySelectorAll('.heart');
        const lostHeart = hearts[state.lives];
        if (lostHeart) { lostHeart.classList.add('losing'); setTimeout(() => { lostHeart.classList.remove('losing'); lostHeart.classList.add('lost'); }, 300); }

        const fb = document.getElementById('feedback');
        fb.className = 'feedback bad';
        fb.textContent = badMessages[Math.floor(Math.random() * badMessages.length)];

        spawnParticles(4, ['#FF0000', '#CC0000', '#880000']);
        showWrongExplanation(wrongVal);

        document.getElementById('answerInput').disabled = true;
        document.querySelectorAll('.hint-btn').forEach(b => b.disabled = true);
        const contRow = document.getElementById('continueRow');
        contRow.style.display = 'block';
        document.getElementById('continueBtn').textContent = state.lives <= 0 ? 'ğŸ“Š ZOBACZ WYNIKI' : 'â–¶ ROZUMIEM, DALEJ!';

        updateUI();
    }

    function continueAfterWrong() {
        document.getElementById('continueRow').style.display = 'none';
        document.getElementById('answerInput').disabled = false;
        if (state.lives <= 0) { state.playing = false; clearInterval(state.timerInterval); showGameOver(); }
        else nextQuestion();
    }

    function showWrongExplanation(wrongVal) {
        const el = document.getElementById('wrongExplain');
        const a = state.a, b = state.b, correct = state.answer;
        const bt = blockTypes[Math.floor(Math.random() * blockTypes.length)];
        const addParts = []; for (let i = 0; i < a; i++) addParts.push(b);
        const addStr = addParts.join(' + ');
        let relateStr = '';
        if (a > 1) relateStr = `<br>ğŸ“– ${a-1} Ã— ${b} = ${(a-1)*b}, dodaj jeszcze ${b} â†’ <strong>${correct}</strong>`;
        if (a === 2) relateStr = `<br>ğŸ“– ${a} Ã— ${b} to po prostu ${b} + ${b} = <strong>${correct}</strong>`;
        if (b === 10) relateStr = `<br>ğŸ“– Ã— 10 = dopisz zero! ${a}0 = <strong>${correct}</strong>`;
        if (b === 5) relateStr = `<br>ğŸ“– Ã— 5: to poÅ‚owa z Ã— 10. ${a}Ã—10=${a*10}, podziel na 2 â†’ <strong>${correct}</strong>`;
        if (a === b) relateStr = `<br>ğŸ“– ${a}Â² (kwadrat ${a}) = <strong>${correct}</strong> â€” zapamiÄ™taj!`;
        let gridHTML = '';
        if (a * b <= 60) {
            gridHTML = `<div class="block-grid" style="grid-template-columns:repeat(${b},18px);margin:8px auto;display:inline-grid;">`;
            for (let i = 0; i < a * b; i++) gridHTML += `<div class="mc-block ${bt}" style="width:18px;height:18px;"></div>`;
            gridHTML += '</div>';
        }
        el.innerHTML = `
            <div class="explain-title">ğŸ“š NAUKA: ${a} Ã— ${b} = ${correct}</div>
            <div class="explain-text">
                ${wrongVal !== undefined ? `Twoja odpowiedÅº: <span style="color:#FF6666;text-decoration:line-through;">${wrongVal}</span><br>` : 'Czas minÄ…Å‚!<br>'}
                Poprawna: <strong style="color:var(--emerald);font-size:14px;">${correct}</strong><br><br>
                ğŸ”¢ ${a} Ã— ${b} = ${addStr} = <strong>${correct}</strong>${relateStr}
            </div>${gridHTML}
            <div style="font-size:7px;color:#888;margin-top:8px;">ğŸ’¡ To pytanie pojawi siÄ™ jeszcze raz!</div>
            <div style="margin-top:10px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap;">
                <button class="mc-btn hint-btn" style="font-size:8px;padding:5px 10px;" onclick="showWrongHint('blocks')">ğŸ§± Bloczki</button>
                <button class="mc-btn hint-btn" style="font-size:8px;padding:5px 10px;" onclick="showWrongHint('skip')">ğŸ”¢ Licz co...</button>
                <button class="mc-btn hint-btn" style="font-size:8px;padding:5px 10px;" onclick="showWrongHint('nearby')">ğŸ“– Blisko!</button>
            </div>`;
        el.classList.add('show');
    }

    function grantLevelReward() {
        // Level up: guaranteed rare+ item
        const rarity = state.level % 5 === 0 ? 'legendary' : state.level % 3 === 0 ? 'epic' : 'rare';
        const candidates = Object.entries(MC_ITEMS).filter(([_, v]) => v.rarity === rarity);
        const [itemKey, item] = candidates[Math.floor(Math.random() * candidates.length)];
        state.inventory[itemKey] = (state.inventory[itemKey] || 0) + 1;
        state.lootLog.push({ itemKey, rarity });
        if (rarity === 'legendary') state._hasLegendary = true;
        spawnLootDrop(item);
        showAchievement(item.icon, `Nagroda za poziom ${state.level}!`, item.name);

        if (state.lives < state.maxLives) state.lives++;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Game Over
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showGameOver() {
        const pct = state.total > 0 ? Math.round((state.correct / state.total) * 100) : 0;
        document.getElementById('finalStats').innerHTML = `
            ğŸ’ Punkty: <span class="val">${state.score}</span><br>
            âœ… Poprawne: <span class="val">${state.correct} / ${state.total} (${pct}%)</span><br>
            ğŸ”¥ Najlepsza seria: <span class="val">${state.bestStreak}</span><br>
            ğŸ’¥ Max combo: <span class="val">Ã—${Math.min(5, 1 + Math.floor(state.bestStreak / 3))}</span><br>
            â¬†ï¸ Poziom: <span class="val">${state.level}</span><br>
            ğŸ† OsiÄ…gniÄ™cia: <span class="val">${state.achievements.size}</span>
        `;

        // Loot summary
        buildLootSummary();

        // Mistakes
        const reviewEl = document.getElementById('mistakesReview');
        if (state.mistakes.length > 0) {
            let html = '<h3>âŒ BÅÄ˜DY DO POWTÃ“RZENIA:</h3>';
            const sorted = [...state.mistakes].sort((a, b) => b.count - a.count);
            for (const m of sorted) {
                html += `<div class="mistake-item"><span class="mistake-q">${m.a} Ã— ${m.b}</span><span class="mistake-wrong">âœ— ${m.lastWrong !== undefined ? m.lastWrong : 'â°'}</span><span class="mistake-right">âœ“ ${m.correctAnswer}</span><span class="mistake-count">Ã—${m.count}</span></div>`;
            }
            html += '<div style="font-size:7px;color:#aaa;text-align:center;margin-top:8px;">Kliknij "ğŸ¯ Ä†WICZ BÅÄ˜DY" aby powtÃ³rzyÄ‡!</div>';
            reviewEl.innerHTML = html;
        } else {
            reviewEl.innerHTML = '<div style="text-align:center;font-size:9px;color:var(--emerald);margin-top:10px;">ğŸ¯ Zero bÅ‚Ä™dÃ³w! Perfekcja!</div>';
        }

        buildMasteryGrid();
        showScreen('gameoverScreen');
    }

    function buildLootSummary() {
        const section = document.getElementById('lootSummary');
        if (state.lootLog.length === 0) { section.innerHTML = ''; return; }

        // Count unique items
        const counts = {};
        for (const l of state.lootLog) {
            counts[l.itemKey] = (counts[l.itemKey] || 0) + 1;
        }

        // Sort by rarity
        const rarityOrder = { legendary: 0, epic: 1, rare: 2, uncommon: 3, common: 4 };
        const sorted = Object.entries(counts).sort((a, b) =>
            rarityOrder[MC_ITEMS[a[0]].rarity] - rarityOrder[MC_ITEMS[b[0]].rarity]
        );

        let html = '<h3>ğŸ ZDOBYTE PRZEDMIOTY:</h3><div class="loot-grid">';
        for (const [itemKey, qty] of sorted) {
            const item = MC_ITEMS[itemKey];
            const cls = item.rarity === 'rare' ? 'rare' : item.rarity === 'epic' ? 'epic' : item.rarity === 'legendary' ? 'legendary' : '';
            html += `<div class="loot-card ${cls}"><div class="loot-icon">${item.icon}</div><div class="loot-name">${item.name}</div><div class="loot-qty">Ã—${qty}</div></div>`;
        }
        html += '</div>';
        section.innerHTML = html;
    }

    function buildMasteryGrid() {
        const section = document.getElementById('masterySection');
        const entries = Object.entries(state.masteryMap);
        if (entries.length === 0) { section.innerHTML = ''; return; }
        let html = '<h3>ğŸ“Š MAPA OPANOWANIA:</h3><div class="mastery-grid">';
        entries.sort((a, b) => { const [a1,a2]=a[0].split('Ã—').map(Number); const [b1,b2]=b[0].split('Ã—').map(Number); return (a1*100+a2)-(b1*100+b2); });
        for (const [key, data] of entries) {
            const pct = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
            let cls = '', stars = '';
            if (data.total > 0) { if (pct >= 80) { cls = 'strong'; stars = 'â­'.repeat(Math.min(3, data.streak)); } else if (pct >= 50) { stars = 'â­'; } else { cls = 'weak'; } }
            html += `<div class="mastery-cell ${cls}">${key.replace('Ã—',' Ã— ')}<br><span class="mastery-stars">${stars||'â€”'}</span><br>${data.total > 0 ? `${pct}%` : 'â€”'}</div>`;
        }
        html += '</div>'; section.innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function updateUI() {
        document.getElementById('score').textContent = state.score;
        document.getElementById('correct').textContent = state.correct;
        document.getElementById('total').textContent = state.total;

        const heartsEl = document.getElementById('hearts');
        heartsEl.innerHTML = '';
        for (let i = 0; i < state.maxLives; i++) {
            const heart = document.createElement('div');
            heart.className = 'heart' + (i >= state.lives ? ' lost' : '');
            heart.innerHTML = `<svg viewBox="0 0 20 18"><path d="M10 18L8.5 16.6C3.4 12 0 9 0 5.2C0 2.3 2.3 0 5.2 0C6.8 0 8.4 0.7 10 2.1C11.6 0.7 13.2 0 14.8 0C17.7 0 20 2.3 20 5.2C20 9 16.6 12 11.5 16.6L10 18Z" fill="${i >= state.lives ? '#555' : '#FF1744'}"/></svg>`;
            heartsEl.appendChild(heart);
        }

        const xpPct = (state.xp / state.xpToNext) * 100;
        document.getElementById('xpBar').style.width = xpPct + '%';
        document.getElementById('xpText').textContent = `${state.xp} / ${state.xpToNext} XP`;
        document.getElementById('xpBarText').textContent = `Poziom ${state.level}`;

        renderCombo();
        renderCurrentGoal();
        renderTrophyShelf();
        renderInventory();
    }

    function renderInventory() {
        const inv = document.getElementById('inventory');
        inv.innerHTML = '';
        // Sort by rarity (best first)
        const rarityOrder = { legendary: 0, epic: 1, rare: 2, uncommon: 3, common: 4 };
        const entries = Object.entries(state.inventory)
            .filter(([_, c]) => c > 0)
            .sort((a, b) => rarityOrder[MC_ITEMS[a[0]].rarity] - rarityOrder[MC_ITEMS[b[0]].rarity]);

        if (entries.length === 0) {
            // Show empty slots
            for (let i = 0; i < 9; i++) { const s = document.createElement('div'); s.className = 'inv-slot'; inv.appendChild(s); }
            return;
        }

        for (const [itemKey, count] of entries) {
            const item = MC_ITEMS[itemKey];
            const slot = document.createElement('div');
            const isLeg = item.rarity === 'legendary';
            slot.className = 'inv-slot active' + (isLeg ? ' legendary' : '');
            slot.innerHTML = `
                ${item.icon}<span class="count">${count}</span>
                <div class="inv-tooltip">
                    <div class="tt-name ${item.rarity === 'rare' ? 'rare' : item.rarity === 'epic' ? 'epic' : item.rarity === 'legendary' ? 'legendary' : ''}">${item.name}</div>
                    <div class="tt-desc">${item.desc}</div>
                    <div class="tt-rarity">${item.rarity.toUpperCase()}</div>
                </div>
            `;
            inv.appendChild(slot);
        }
        // Fill remaining slots
        const remaining = Math.max(0, 9 - entries.length);
        for (let i = 0; i < remaining; i++) { const s = document.createElement('div'); s.className = 'inv-slot'; inv.appendChild(s); }
    }

    function getNextGoal() {
        for (const ach of achievementList) {
            if (!state.achievements.has(ach.id)) return ach;
        }
        return null; // all done!
    }

    function renderCurrentGoal() {
        const container = document.getElementById('goalContent');
        const goal = getNextGoal();

        if (!goal) {
            container.innerHTML = '<div class="goal-done-msg">ğŸ† Wszystkie nagrody zdobyte! JesteÅ› LEGENDÄ„! ğŸ‘‘</div>';
            return;
        }

        const prog = goal.progress(state);
        const pct = Math.min(100, Math.round((prog.cur / prog.max) * 100));
        const isFull = pct >= 100;

        container.innerHTML = `
            <div class="goal-icon" id="goalIcon">${goal.icon}</div>
            <div class="goal-info">
                <div class="goal-title">${goal.title}</div>
                <div class="goal-desc">${goal.desc}</div>
                <div class="goal-progress-bg">
                    <div class="goal-progress-fill${isFull ? ' full' : ''}" style="width:${pct}%"></div>
                    <div class="goal-progress-text">${prog.label}: ${Math.min(prog.cur, prog.max)} / ${prog.max}</div>
                </div>
            </div>
        `;
    }

    function renderTrophyShelf() {
        const shelf = document.getElementById('trophyShelf');
        shelf.innerHTML = '';

        for (const ach of achievementList) {
            const slot = document.createElement('div');
            const isEarned = state.achievements.has(ach.id);
            const isNew = state._newTrophies && state._newTrophies.has(ach.id);

            slot.className = 'trophy-slot' + (isEarned ? ' earned' : ' empty') + (isNew ? ' new-earned' : '');

            if (isEarned) {
                slot.innerHTML = `
                    ${ach.icon}
                    <div class="trophy-tooltip">
                        <div class="tt-name">${ach.title}</div>
                        <div class="tt-desc">${ach.desc}</div>
                    </div>
                `;
            }

            shelf.appendChild(slot);
        }

        // Clear new flags after render
        if (state._newTrophies) {
            setTimeout(() => { state._newTrophies = null; }, 1000);
        }
    }

    function checkAchievements() {
        let anyNew = false;
        for (const ach of achievementList) {
            if (!state.achievements.has(ach.id) && ach.check(state)) {
                state.achievements.add(ach.id);
                if (!state._newTrophies) state._newTrophies = new Set();
                state._newTrophies.add(ach.id);
                anyNew = true;
            }
        }
        if (anyNew) {
            // Flash the goal panel
            const panel = document.getElementById('goalContent');
            panel.classList.add('completed');
            const icon = document.getElementById('goalIcon');
            if (icon) icon.classList.add('earned');

            // After celebration, update to next goal
            setTimeout(() => {
                panel.classList.remove('completed');
                renderCurrentGoal();
                renderTrophyShelf();
            }, 1500);
        } else {
            renderCurrentGoal();
        }
    }

    function showAchievement(icon, title, desc) {
        // Mini floating notification for level-ups etc.
        const el = document.createElement('div');
        el.className = 'float-score';
        el.style.color = '#FCDB05';
        el.style.fontSize = '11px';
        el.textContent = `${icon} ${title}`;
        el.style.left = (window.innerWidth / 2 - 80) + 'px';
        el.style.top = (window.innerHeight / 2 - 120) + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1200);
        renderCurrentGoal();
        renderTrophyShelf();
    }

    function spawnParticles(count, colors) {
        const c = document.getElementById('particles');
        const cx = window.innerWidth / 2, cy = window.innerHeight / 2;
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div'); p.className = 'particle';
            p.style.left = (cx + (Math.random() - 0.5) * 200) + 'px';
            p.style.top = (cy + (Math.random() - 0.5) * 100) + 'px';
            p.style.background = colors[Math.floor(Math.random() * colors.length)];
            c.appendChild(p); setTimeout(() => p.remove(), 1000);
        }
    }

    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
</script>
</body>
</html>