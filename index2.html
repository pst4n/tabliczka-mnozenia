<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabliczka Mno≈ºenia - Minecraft Edition v2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --dirt: #8B6914; --dirt-dark: #6B4F0A;
            --grass: #5D9B2A; --grass-dark: #4A7B20;
            --stone: #7F7F7F; --stone-dark: #5F5F5F;
            --wood: #BC9862; --wood-dark: #8B6914;
            --diamond: #5DECF5; --gold: #FCDB05; --emerald: #17DD62;
            --redstone: #FF0000; --obsidian: #1B1029;
            --sky-top: #78A7FF; --sky-bottom: #C9E4FF;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bottom) 60%, var(--grass) 60%, var(--grass-dark) 62%, var(--dirt) 62%, var(--dirt-dark) 100%);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; image-rendering: pixelated;
        }

        .clouds { position: fixed; top: 0; left: 0; width: 100%; height: 60vh; pointer-events: none; z-index: 0; overflow: hidden; }
        .cloud { position: absolute; background: white; opacity: 0.9; animation: float-cloud linear infinite; }
        .cloud::before, .cloud::after { content: ''; position: absolute; background: white; }
        .cloud-1 { width: 80px; height: 30px; top: 40px; animation-duration: 45s; }
        .cloud-1::before { width: 40px; height: 20px; top: -15px; left: 10px; }
        .cloud-1::after { width: 30px; height: 15px; top: -10px; left: 40px; }
        .cloud-2 { width: 100px; height: 35px; top: 100px; animation-duration: 60s; animation-delay: -20s; }
        .cloud-2::before { width: 50px; height: 25px; top: -18px; left: 15px; }
        .cloud-2::after { width: 35px; height: 18px; top: -12px; left: 55px; }
        .cloud-3 { width: 60px; height: 25px; top: 70px; animation-duration: 55s; animation-delay: -35s; }
        .cloud-3::before { width: 30px; height: 15px; top: -10px; left: 8px; }
        .cloud-3::after { width: 25px; height: 12px; top: -8px; left: 30px; }
        @keyframes float-cloud { from { left: -150px; } to { left: 110%; } }

        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .particle { position: absolute; width: 8px; height: 8px; pointer-events: none; animation: particle-fall 1s ease-out forwards; }
        @keyframes particle-fall { 0% { opacity: 1; transform: scale(1) translateY(0); } 100% { opacity: 0; transform: scale(0.3) translateY(60px); } }

        .game-container { position: relative; z-index: 1; width: 100%; max-width: 700px; padding: 20px; margin-top: 20px; }

        .title { text-align: center; margin-bottom: 20px; }
        .title h1 { font-size: 18px; color: #333; text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff; line-height: 1.6; }
        .title h1 .green { color: var(--grass-dark); }
        .title h1 .brown { color: var(--dirt-dark); }

        .mc-panel {
            background: #C6C6C6; border: 3px solid #000;
            box-shadow: inset 2px 2px 0 #FFFFFF, inset -2px -2px 0 #555555;
            padding: 16px; margin-bottom: 16px;
        }

        .stats-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .stat { display: flex; align-items: center; gap: 6px; font-size: 10px; color: #333; }

        .xp-section { margin-top: 10px; }
        .xp-label { font-size: 9px; color: #333; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .xp-bar-bg { height: 16px; background: #222; border: 2px solid #000; box-shadow: inset 1px 1px 0 #444; position: relative; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(180deg, #7FFF00, #32CD32); transition: width 0.5s ease; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2); }
        .xp-bar-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 7px; color: #fff; text-shadow: 1px 1px 0 #000; }

        .question-area { text-align: center; padding: 20px 10px; }
        .question-text { font-size: 28px; color: #3F3F3F; text-shadow: 2px 2px 0 #aaa; margin-bottom: 20px; letter-spacing: 4px; }
        .answer-row { display: flex; align-items: center; justify-content: center; gap: 10px; }

        .answer-input {
            font-family: 'Press Start 2P', monospace; font-size: 22px; width: 140px; padding: 10px;
            text-align: center; background: #000; color: #fff; border: 3px solid #555;
            box-shadow: inset 2px 2px 0 #333; outline: none;
        }
        .answer-input:focus { border-color: var(--diamond); box-shadow: inset 2px 2px 0 #333, 0 0 10px rgba(93,236,245,0.5); }
        .answer-input.correct { border-color: var(--emerald); box-shadow: inset 2px 2px 0 #333, 0 0 15px rgba(23,221,98,0.6); }
        .answer-input.wrong { border-color: var(--redstone); box-shadow: inset 2px 2px 0 #333, 0 0 15px rgba(255,0,0,0.6); animation: shake 0.4s ease; }
        @keyframes shake { 0%,100% { transform: translateX(0); } 20% { transform: translateX(-8px); } 40% { transform: translateX(8px); } 60% { transform: translateX(-6px); } 80% { transform: translateX(4px); } }

        /* ‚ïê‚ïê‚ïê MC NUMPAD ‚ïê‚ïê‚ïê */
        .mc-display {
            font-family: 'Press Start 2P', monospace; font-size: 32px;
            min-width: 160px; min-height: 50px; padding: 8px 16px;
            text-align: center; background: #000; color: #fff; border: 3px solid #555;
            box-shadow: inset 2px 2px 0 #333; margin: 0 auto 12px;
            display: flex; align-items: center; justify-content: center;
            letter-spacing: 6px; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .mc-display.active { border-color: var(--diamond); box-shadow: inset 2px 2px 0 #333, 0 0 10px rgba(93,236,245,0.5); }
        .mc-display.correct { border-color: var(--emerald); box-shadow: inset 2px 2px 0 #333, 0 0 15px rgba(23,221,98,0.6); }
        .mc-display.wrong { border-color: var(--redstone); box-shadow: inset 2px 2px 0 #333, 0 0 15px rgba(255,0,0,0.6); animation: shake 0.4s ease; }
        .mc-display .cursor { animation: blink 0.8s step-end infinite; }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

        .mc-numpad { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; max-width: 280px; margin: 0 auto; }
        .mc-numkey {
            font-family: 'Press Start 2P', monospace; font-size: 18px; padding: 14px 0;
            background: #7F7F7F; color: #fff; border: 3px solid #000;
            box-shadow: inset 2px 2px 0 #AAA, inset -2px -2px 0 #555;
            cursor: pointer; text-shadow: 1px 1px 0 #333; transition: background 0.1s;
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
            text-align: center; min-width: 0; overflow: hidden;
        }
        .mc-numkey:hover { background: #999; }
        .mc-numkey:active { background: #666; box-shadow: inset -2px -2px 0 #AAA, inset 2px 2px 0 #555; transform: translateY(1px); }
        .mc-numkey.key-ok { background: #5A9E2F; box-shadow: inset 2px 2px 0 #7BCF44, inset -2px -2px 0 #3B6B1E; font-size: 18px; }
        .mc-numkey.key-ok:hover { background: #6AB33A; }
        .mc-numkey.key-ok:active { background: #4A8B22; }
        .mc-numkey.key-del { background: #B8860B; box-shadow: inset 2px 2px 0 #DAA520, inset -2px -2px 0 #8B6508; font-size: 18px; }
        .mc-numkey.key-del:hover { background: #CC9A1E; }
        .mc-numkey.key-del:active { background: #9A7209; }
        .mc-numkey.key-0 { grid-column: 2; }

        @media (max-width: 500px) {
            .mc-numpad { max-width: 240px; gap: 4px; }
            .mc-numkey { font-size: 16px; padding: 12px 0; }
            .mc-display { font-size: 26px; min-height: 44px; }
        }

        .mc-btn {
            font-family: 'Press Start 2P', monospace; font-size: 12px; padding: 10px 20px;
            background: #999; color: #fff; border: 3px solid #000;
            box-shadow: inset 2px 2px 0 #CCC, inset -2px -2px 0 #555;
            cursor: pointer; text-shadow: 1px 1px 0 #333; transition: background 0.1s;
        }
        .mc-btn:hover { background: #AAA; }
        .mc-btn:active { background: #777; box-shadow: inset -2px -2px 0 #CCC, inset 2px 2px 0 #555; }
        .mc-btn.primary { background: #5A9E2F; box-shadow: inset 2px 2px 0 #7BCF44, inset -2px -2px 0 #3B6B1E; }
        .mc-btn.primary:hover { background: #6AB33A; }

        .mc-btn.hint-btn { background: #B8860B; box-shadow: inset 2px 2px 0 #DAA520, inset -2px -2px 0 #8B6508; font-size: 10px; padding: 8px 14px; }
        .mc-btn.hint-btn:hover { background: #CC9A1E; }
        .mc-btn.hint-btn:disabled { background: #666; opacity: 0.5; cursor: default; }
        .mc-btn.hint-btn.hint-active { background: #DAA520; border-color: var(--gold); box-shadow: inset 2px 2px 0 #FFD700, inset -2px -2px 0 #8B6508, 0 0 8px rgba(218,165,32,0.4); }

        .feedback { text-align: center; min-height: 30px; margin-top: 15px; font-size: 11px; transition: opacity 0.3s; }
        .feedback.good { color: #17DD62; text-shadow: 1px 1px 0 #000; }
        .feedback.bad { color: #FF4444; text-shadow: 1px 1px 0 #000; }

        .hearts { display: flex; gap: 4px; align-items: center; }
        .heart { width: 20px; height: 18px; position: relative; }
        .heart svg { width: 100%; height: 100%; }
        .heart.lost svg { opacity: 0.25; }
        .heart.losing svg { animation: heart-break 0.3s ease; }
        @keyframes heart-break { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); opacity: 0.25; } }

        /* ‚ïê‚ïê‚ïê INVENTORY ‚ïê‚ïê‚ïê */
        .inventory { display: flex; justify-content: center; gap: 2px; margin-top: 12px; flex-wrap: wrap; }
        .inv-slot {
            width: 48px; height: 48px; background: #555; border: 2px solid #000;
            box-shadow: inset 1px 1px 0 #777, inset -1px -1px 0 #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; position: relative; cursor: default;
        }
        .inv-slot .count { position: absolute; bottom: 1px; right: 3px; font-size: 7px; color: #fff; text-shadow: 1px 1px 0 #000; }
        .inv-slot.active { border-color: #fff; box-shadow: inset 1px 1px 0 #aaa, inset -1px -1px 0 #555, 0 0 8px rgba(255,255,255,0.3); }
        .inv-slot.legendary { border-color: #FF00FF; box-shadow: inset 1px 1px 0 #FF88FF, inset -1px -1px 0 #880088, 0 0 12px rgba(255,0,255,0.4); animation: legendary-glow 2s ease infinite; }
        @keyframes legendary-glow { 0%,100% { box-shadow: inset 1px 1px 0 #FF88FF, inset -1px -1px 0 #880088, 0 0 8px rgba(255,0,255,0.3); } 50% { box-shadow: inset 1px 1px 0 #FF88FF, inset -1px -1px 0 #880088, 0 0 16px rgba(255,0,255,0.6); } }

        /* Tooltip */
        .inv-tooltip {
            display: none; position: absolute; bottom: 54px; left: 50%; transform: translateX(-50%);
            background: #1A0A2E; border: 2px solid #5500AA; padding: 6px 10px; z-index: 50;
            white-space: nowrap; pointer-events: none; min-width: 120px;
        }
        .inv-slot:hover .inv-tooltip { display: block; }
        .inv-tooltip .tt-name { font-size: 7px; color: #fff; margin-bottom: 3px; }
        .inv-tooltip .tt-name.rare { color: var(--diamond); }
        .inv-tooltip .tt-name.epic { color: #FF00FF; }
        .inv-tooltip .tt-name.legendary { color: var(--gold); }
        .inv-tooltip .tt-desc { font-size: 6px; color: #888; line-height: 1.6; }
        .inv-tooltip .tt-rarity { font-size: 6px; color: #666; margin-top: 2px; font-style: italic; }

        /* ‚ïê‚ïê‚ïê FLOATING SCORE ‚ïê‚ïê‚ïê */
        .float-score {
            position: fixed; pointer-events: none; z-index: 150;
            font-family: 'Press Start 2P', monospace; font-size: 14px;
            text-shadow: 2px 2px 0 #000;
            animation: float-up 1.2s ease-out forwards;
        }
        @keyframes float-up { 0% { opacity: 1; transform: translateY(0) scale(1); } 40% { transform: translateY(-30px) scale(1.2); } 100% { opacity: 0; transform: translateY(-80px) scale(0.8); } }

        /* ‚ïê‚ïê‚ïê SPEED INDICATOR ‚ïê‚ïê‚ïê */
        .speed-badge {
            display: inline-block; padding: 3px 8px; font-size: 8px; margin-top: 6px;
            border: 2px solid; text-align: center;
        }
        .speed-badge.lightning { color: #FCDB05; border-color: #FCDB05; background: rgba(252,219,5,0.15); }
        .speed-badge.fast { color: #5DECF5; border-color: #5DECF5; background: rgba(93,236,245,0.1); }
        .speed-badge.good { color: var(--emerald); border-color: var(--emerald); background: rgba(23,221,98,0.1); }
        .speed-badge.ok { color: #aaa; border-color: #777; background: rgba(255,255,255,0.05); }

        /* ‚ïê‚ïê‚ïê COMBO METER ‚ïê‚ïê‚ïê */
        .combo-container { text-align: center; min-height: 24px; margin-top: 6px; }
        .combo-text { font-size: 12px; text-shadow: 2px 2px 0 #000; }
        .combo-text.x2 { color: #5DECF5; }
        .combo-text.x3 { color: var(--gold); }
        .combo-text.x4 { color: #FF00FF; }
        .combo-text.x5 { color: #FF4444; animation: combo-pulse 0.5s ease infinite; }
        @keyframes combo-pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .combo-bar-bg { height: 6px; background: #333; border: 1px solid #555; margin-top: 3px; overflow: hidden; }
        .combo-bar-fill { height: 100%; transition: width 0.3s ease; }

        /* ‚ïê‚ïê‚ïê LOOT DROP ANIMATION ‚ïê‚ïê‚ïê */
        .loot-drop {
            position: fixed; pointer-events: none; z-index: 150;
            font-size: 28px;
            animation: loot-bounce 1s ease forwards;
        }
        @keyframes loot-bounce {
            0% { opacity: 0; transform: translateY(-40px) scale(0.3) rotate(-20deg); }
            30% { opacity: 1; transform: translateY(10px) scale(1.3) rotate(10deg); }
            50% { transform: translateY(-10px) scale(1) rotate(-5deg); }
            70% { transform: translateY(5px) scale(1.05) rotate(2deg); }
            85% { opacity: 1; transform: translateY(0) scale(1) rotate(0); }
            100% { opacity: 0; transform: translateY(-20px) scale(0.5); }
        }

        /* Difficulty */
        .difficulty { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin: 12px 0; }
        .diff-btn {
            font-family: 'Press Start 2P', monospace; font-size: 9px; padding: 8px 14px; cursor: pointer;
            background: #666; color: #aaa; border: 2px solid #000;
            box-shadow: inset 1px 1px 0 #888, inset -1px -1px 0 #444;
        }
        .diff-btn.active { background: #5A9E2F; color: #fff; box-shadow: inset 1px 1px 0 #7BCF44, inset -1px -1px 0 #3B6B1E; }
        .diff-btn:hover { background: #777; color: #ddd; }
        .diff-btn.active:hover { background: #6AB33A; color: #fff; }

        /* ‚ïê‚ïê‚ïê GOAL PANEL (current achievement target) ‚ïê‚ïê‚ïê */
        .goal-panel { display: flex; align-items: center; gap: 12px; padding: 10px 14px; position: relative; overflow: hidden; }
        .goal-panel.completed { animation: goal-flash 1.5s ease; }
        @keyframes goal-flash {
            0% { background: #C6C6C6; }
            15% { background: #FCDB05; box-shadow: inset 0 0 30px rgba(252,219,5,0.6); }
            40% { background: #FFE066; }
            100% { background: #C6C6C6; }
        }
        .goal-icon { font-size: 32px; min-width: 40px; text-align: center; animation: goal-bob 2.5s ease-in-out infinite; }
        @keyframes goal-bob { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .goal-icon.earned { animation: goal-earned 0.6s ease forwards; }
        @keyframes goal-earned { 0% { transform: scale(1); } 40% { transform: scale(1.5) rotate(10deg); } 70% { transform: scale(1.2) rotate(-5deg); } 100% { transform: scale(1) rotate(0); } }
        .goal-info { flex: 1; min-width: 0; }
        .goal-title { font-size: 9px; color: var(--gold); margin-bottom: 3px; text-shadow: 1px 1px 0 rgba(0,0,0,0.2); }
        .goal-desc { font-size: 7px; color: #555; margin-bottom: 6px; }
        .goal-progress-bg { height: 14px; background: #222; border: 2px solid #000; box-shadow: inset 1px 1px 0 #444; position: relative; overflow: hidden; }
        .goal-progress-fill { height: 100%; background: linear-gradient(180deg, var(--gold), #D4A800); transition: width 0.5s ease; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2); }
        .goal-progress-fill.full { background: linear-gradient(180deg, #7FFF00, #32CD32); }
        .goal-progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 7px; color: #fff; text-shadow: 1px 1px 0 #000; white-space: nowrap; }
        .goal-done-msg { text-align: center; font-size: 8px; color: var(--emerald); padding: 10px; }

        /* ‚ïê‚ïê‚ïê TROPHY SHELF ‚ïê‚ïê‚ïê */
        .trophy-shelf { display: flex; gap: 3px; flex-wrap: wrap; justify-content: center; margin-top: 6px; }
        .trophy-slot {
            width: 42px; height: 42px; background: #3A3A1A; border: 2px solid #555;
            box-shadow: inset 1px 1px 0 #666, inset -1px -1px 0 #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; position: relative; cursor: default;
        }
        .trophy-slot.empty { background: #444; opacity: 0.4; }
        .trophy-slot.empty::after { content: '?'; font-size: 14px; color: #666; }
        .trophy-slot.earned { border-color: var(--gold); box-shadow: inset 1px 1px 0 #FFE066, inset -1px -1px 0 #8B6508, 0 0 6px rgba(252,219,5,0.3); background: linear-gradient(180deg, #4A4A2A, #3A3A1A); }
        .trophy-slot.new-earned { animation: trophy-arrive 0.8s ease forwards; }
        @keyframes trophy-arrive {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.3) rotate(10deg); opacity: 1; }
            75% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        .trophy-tooltip {
            display: none; position: absolute; bottom: 48px; left: 50%; transform: translateX(-50%);
            background: #1A0A2E; border: 2px solid var(--gold); padding: 6px 10px; z-index: 50;
            white-space: nowrap; pointer-events: none; min-width: 110px; text-align: center;
        }
        .trophy-slot:hover .trophy-tooltip { display: block; }
        .trophy-tooltip .tt-name { font-size: 7px; color: var(--gold); margin-bottom: 2px; }
        .trophy-tooltip .tt-desc { font-size: 6px; color: #aaa; }

        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }
        .start-screen { text-align: center; }
        .start-screen .big-icon { font-size: 60px; margin: 20px 0; animation: bob 2s ease-in-out infinite; }
        @keyframes bob { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .start-screen p { font-size: 9px; color: #555; margin: 12px 0; line-height: 1.8; }

        .gameover-screen { text-align: center; }
        .gameover-screen h2 { font-size: 16px; color: #333; margin-bottom: 15px; }
        .gameover-screen .final-stats { font-size: 10px; color: #555; line-height: 2.2; }
        .gameover-screen .final-stats .val { color: var(--grass-dark); }

        .streak-display { text-align: center; font-size: 10px; color: #FF8800; text-shadow: 1px 1px 0 #000; min-height: 18px; margin-top: 6px; }

        .timer-section { margin-top: 8px; display: none; }
        .timer-section.visible { display: block; }
        .timer-bar-bg { height: 10px; background: #222; border: 2px solid #000; overflow: hidden; }
        .timer-bar-fill { height: 100%; background: linear-gradient(180deg, #FF6B00, #FF4400); transition: width 0.1s linear; }
        .timer-bar-fill.warning { background: linear-gradient(180deg, #FF0000, #CC0000); animation: pulse-red 0.5s ease infinite; }
        @keyframes pulse-red { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Hint system */
        .hint-row { display: flex; justify-content: center; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .visual-hint { margin-top: 16px; padding: 12px; background: #3A3A3A; border: 2px solid #555; display: none; text-align: center; }
        .visual-hint.show { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .hint-title { font-size: 8px; color: var(--gold); margin-bottom: 10px; }
        .hint-explanation { font-size: 8px; color: #ccc; margin-bottom: 10px; line-height: 1.8; }
        .block-grid { display: inline-grid; gap: 2px; margin: 8px auto; }
        .mc-block { width: 22px; height: 22px; border: 1px solid rgba(0,0,0,0.4); image-rendering: pixelated; transition: all 0.15s ease; }
        .mc-block.grass { background: linear-gradient(180deg, #5D9B2A 0%, #5D9B2A 30%, #8B6914 30%); }
        .mc-block.dirt { background: #8B6914; }
        .mc-block.stone { background: linear-gradient(135deg, #888 25%, #777 50%, #999 75%); }
        .mc-block.diamond { background: linear-gradient(135deg, #5DECF5 0%, #2BC4D8 50%, #5DECF5 100%); }
        .mc-block.gold { background: linear-gradient(135deg, #FCDB05 0%, #D4A800 50%, #FCDB05 100%); }
        .mc-block.wood { background: linear-gradient(0deg, #8B6914 0%, #BC9862 50%, #8B6914 100%); }
        .mc-block.highlight { animation: block-pop 0.3s ease forwards; box-shadow: 0 0 6px rgba(255,255,255,0.5); }
        @keyframes block-pop { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }
        .grid-label { font-size: 8px; color: #aaa; margin: 4px 0; }
        .grid-result { font-size: 12px; color: var(--emerald); margin-top: 8px; text-shadow: 1px 1px 0 #000; }
        .skip-count { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; margin: 10px 0; }
        .skip-num { background: #555; border: 2px solid #777; padding: 5px 8px; font-size: 10px; color: #ccc; min-width: 36px; text-align: center; }
        .skip-num.revealed { background: #2B6B1E; border-color: var(--emerald); color: #fff; animation: fadeIn 0.3s ease; }
        .skip-num.answer-num { background: #8B6508; border-color: var(--gold); color: var(--gold); font-size: 12px; }
        .skip-num.hidden { color: #555; }
        .nearby-facts { display: flex; flex-direction: column; gap: 4px; margin: 8px 0; align-items: center; }
        .nearby-fact { font-size: 9px; color: #aaa; padding: 3px 10px; }
        .nearby-fact.current { color: var(--gold); font-size: 11px; background: rgba(252,219,5,0.1); border: 1px solid rgba(252,219,5,0.3); }
        .nearby-fact .op { color: #888; }

        .wrong-explain { margin-top: 12px; padding: 12px; background: #2A1A1A; border: 2px solid #FF4444; display: none; text-align: center; }
        .wrong-explain.show { display: block; animation: fadeIn 0.4s ease; }
        .wrong-explain .explain-title { font-size: 8px; color: #FF8888; margin-bottom: 8px; }
        .wrong-explain .explain-text { font-size: 8px; color: #ccc; line-height: 1.8; margin-bottom: 8px; }

        .mistakes-review { margin-top: 16px; text-align: left; }
        .mistakes-review h3 { font-size: 10px; color: #FF8888; margin-bottom: 10px; text-align: center; }
        .mistake-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 4px; background: #555; border: 1px solid #777; font-size: 9px; gap: 8px; }
        .mistake-item .mistake-q { color: #fff; }
        .mistake-item .mistake-wrong { color: #FF6666; text-decoration: line-through; }
        .mistake-item .mistake-right { color: var(--emerald); }
        .mistake-item .mistake-count { color: var(--gold); font-size: 7px; }

        .hint-cost { font-size: 7px; color: #aaa; text-align: center; margin-top: 4px; }

        .mastery-section { margin-top: 16px; text-align: center; }
        .mastery-section h3 { font-size: 10px; color: var(--gold); margin-bottom: 10px; }
        .mastery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 4px; max-width: 400px; margin: 0 auto; }
        .mastery-cell { background: #444; border: 1px solid #666; padding: 4px; font-size: 7px; text-align: center; color: #ccc; }
        .mastery-cell .mastery-stars { color: var(--gold); font-size: 8px; }
        .mastery-cell.strong { background: #1A3A1A; border-color: var(--emerald); }
        .mastery-cell.weak { background: #3A1A1A; border-color: #FF4444; }

        /* Loot summary on game over */
        .loot-summary { margin-top: 12px; }
        .loot-summary h3 { font-size: 10px; color: var(--diamond); margin-bottom: 8px; }
        .loot-grid { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .loot-card { background: #444; border: 2px solid #666; padding: 6px 10px; text-align: center; min-width: 70px; }
        .loot-card.rare { border-color: var(--diamond); }
        .loot-card.epic { border-color: #FF00FF; }
        .loot-card.legendary { border-color: var(--gold); }
        .loot-card .loot-icon { font-size: 20px; }
        .loot-card .loot-name { font-size: 6px; color: #ccc; margin-top: 3px; }
        .loot-card .loot-qty { font-size: 7px; color: var(--gold); }

        /* ‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê */
        .leaderboard { margin-top: 16px; }
        .leaderboard h3 { font-size: 10px; color: var(--gold); margin-bottom: 10px; text-align: center; }
        .lb-table { width: 100%; border-collapse: collapse; }
        .lb-table th { font-size: 7px; color: #555; text-align: left; padding: 4px 6px; border-bottom: 2px solid #999; }
        .lb-table td { font-size: 8px; color: #333; padding: 5px 6px; border-bottom: 1px solid #aaa; }
        .lb-table tr.current { background: rgba(252,219,5,0.25); }
        .lb-table tr.current td { color: #8B6508; font-weight: bold; }
        .lb-rank { color: #555; width: 30px; }
        .lb-rank.gold { color: var(--gold); }
        .lb-rank.silver { color: #C0C0C0; }
        .lb-rank.bronze { color: #CD7F32; }
        .lb-name { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .lb-score { color: #0088AA; text-align: right; font-weight: bold; }
        .lb-diff { font-size: 6px; color: #666; }
        .player-greeting { text-align: center; font-size: 9px; color: var(--gold); margin-bottom: 6px; text-shadow: 1px 1px 0 rgba(0,0,0,0.2); }

        /* ‚ïê‚ïê‚ïê MAIN TIMER (3 min) ‚ïê‚ïê‚ïê */
        .main-timer { text-align: center; font-size: 20px; color: #fff; text-shadow: 2px 2px 0 #000; margin-bottom: 4px; letter-spacing: 2px; }
        .main-timer.warning { color: #FF4444; animation: pulse-red 0.5s ease infinite; }
        .main-timer-bar-bg { height: 12px; background: #222; border: 2px solid #000; overflow: hidden; margin-bottom: 8px; }
        .main-timer-bar-fill { height: 100%; background: linear-gradient(180deg, #5DECF5, #2BC4D8); transition: width 0.5s linear; }
        .main-timer-bar-fill.low { background: linear-gradient(180deg, #FF6B00, #FF4400); }
        .main-timer-bar-fill.critical { background: linear-gradient(180deg, #FF0000, #CC0000); animation: pulse-red 0.5s ease infinite; }

        /* ‚ïê‚ïê‚ïê BRAINROT CATALOG ‚ïê‚ïê‚ïê */
        .brainrot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; margin-top: 12px; }
        .brainrot-card {
            background: #444; border: 3px solid #666; padding: 10px; text-align: center; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .brainrot-card:hover { transform: translateY(-2px); }
        .brainrot-card.owned { border-color: var(--emerald); background: #1A3A1A; box-shadow: 0 0 10px rgba(23,221,98,0.3); }
        .brainrot-card.common { border-color: #aaa; }
        .brainrot-card.rare { border-color: var(--diamond); }
        .brainrot-card.epic { border-color: #FF00FF; }
        .brainrot-card.legendary { border-color: var(--gold); }
        .brainrot-card.god { border-color: #FF4444; box-shadow: 0 0 15px rgba(255,0,0,0.3); animation: legendary-glow 2s ease infinite; }
        .brainrot-icon { width: 80px; height: 80px; margin: 0 auto 6px; border-radius: 8px; overflow: hidden; border: 2px solid #555; }
        .brainrot-icon img { width: 100%; height: 100%; object-fit: cover; image-rendering: auto; }
        .brainrot-icon.locked { filter: grayscale(1) brightness(0.3); }
        .brainrot-name { font-size: 8px; color: #fff; margin-bottom: 4px; }
        .brainrot-desc { font-size: 6px; color: #aaa; margin-bottom: 6px; line-height: 1.6; }
        .brainrot-rarity { font-size: 6px; font-style: italic; margin-bottom: 4px; }
        .brainrot-rarity.common { color: #aaa; }
        .brainrot-rarity.rare { color: var(--diamond); }
        .brainrot-rarity.epic { color: #FF00FF; }
        .brainrot-rarity.legendary { color: var(--gold); }
        .brainrot-rarity.god { color: #FF4444; }
        .brainrot-goal { font-size: 7px; color: #888; margin-bottom: 4px; }
        .brainrot-progress-bg { height: 10px; background: #222; border: 1px solid #555; overflow: hidden; }
        .brainrot-progress-fill { height: 100%; background: linear-gradient(180deg, var(--diamond), #2BC4D8); transition: width 0.3s; }
        .brainrot-progress-fill.full { background: linear-gradient(180deg, #7FFF00, #32CD32); }
        .brainrot-owned-badge { font-size: 7px; color: var(--emerald); margin-top: 4px; }
        .brainrot-stats { font-size: 6px; color: #777; margin-top: 4px; line-height: 1.6; }
        .nav-links { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 12px; }

        @media (max-width: 500px) {
            .title h1 { font-size: 13px; }
            .question-text { font-size: 22px; }
            .answer-input { font-size: 18px; width: 110px; }
            .stat { font-size: 8px; }
            .inv-slot { width: 40px; height: 40px; font-size: 18px; }
            .mc-btn { font-size: 10px; padding: 8px 14px; }
            .mc-block { width: 16px; height: 16px; }
            .brainrot-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>

<div class="clouds"><div class="cloud cloud-1"></div><div class="cloud cloud-2"></div><div class="cloud cloud-3"></div></div>
<div class="particles" id="particles"></div>


<div class="game-container">
    <div class="title"><h1>‚õèÔ∏è <span class="green">TABLICZKA</span> <span class="brown">MNO≈ªENIA</span> ‚õèÔ∏è<br>Minecraft Edition</h1></div>

    <!-- START -->
    <div id="startScreen" class="screen active">
        <div class="mc-panel start-screen">
            <div class="big-icon">‚õèÔ∏è</div>
            <p>
                RozwiƒÖzuj zadania z tabliczki mno≈ºenia,<br>
                zbieraj Minecraftowe przedmioty i brainroty!<br><br>
                ‚è±Ô∏è Masz 2 minuty na rundƒô!<br>
                ‚ö° Im szybciej, tym wiƒôcej punkt√≥w!<br>
                üî• Buduj combo! üß† Odblokuj brainroty!
            </p>
            <div style="margin: 16px 0;">
                <div style="font-size: 9px; color: #555; margin-bottom: 8px;">TWOJE IMIƒò:</div>
                <input type="text" id="playerName" class="answer-input" style="font-size:14px;width:200px;margin-bottom:16px;" placeholder="Wpisz imiƒô..." maxlength="20" value="">
            </div>
            <div style="margin: 16px 0;">
                <div style="font-size: 9px; color: #555; margin-bottom: 8px;">WYBIERZ POZIOM:</div>
                <div class="difficulty">
                    <button class="diff-btn active" onclick="setDifficulty('easy', this)">üòä ≈Åatwy<br><span style="font-size:7px;">2-5</span></button>
                    <button class="diff-btn" onclick="setDifficulty('medium', this)">üòé ≈öredni<br><span style="font-size:7px;">2-10</span></button>
                    <button class="diff-btn" onclick="setDifficulty('hard', this)">üíÄ Trudny<br><span style="font-size:7px;">2-12 + timer/pyt</span></button>
                </div>
            </div>
            <button class="mc-btn primary" onclick="startGame()" style="font-size: 14px; padding: 14px 30px;">‚ñ∂ GRAJ!</button>
            <div class="nav-links">
                <button class="mc-btn" onclick="showScreen('leaderboardScreen')" style="font-size: 9px;">üèÜ RANKING</button>
                <button class="mc-btn" onclick="showScreen('catalogScreen')" style="font-size: 9px;">üß† KOLEKCJA BRAINROT</button>
            </div>
        </div>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="screen">
        <div class="mc-panel">
            <div class="main-timer" id="mainTimer">‚è±Ô∏è 2:00</div>
            <div class="main-timer-bar-bg"><div class="main-timer-bar-fill" id="mainTimerBar" style="width:100%"></div></div>
            <div class="stats-bar">
                <div class="stat">üíé <span id="score">0</span></div>
                <div class="stat">‚úÖ <span id="correct">0</span>/<span id="total">0</span></div>
                <div class="stat">‚¨ÜÔ∏è Poz. <span id="levelDisplay">1</span></div>
            </div>
            <div class="xp-section">
                <div class="xp-label"><span>DO≈öWIADCZENIE</span><span id="xpText">0 / 100 XP</span></div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpBar" style="width:0%"></div><div class="xp-bar-text" id="xpBarText">Poziom 1</div></div>
            </div>
            <div class="timer-section" id="timerSection"><div class="timer-bar-bg"><div class="timer-bar-fill" id="timerBar" style="width:100%"></div></div></div>
            <div class="combo-container" id="comboContainer"></div>
        </div>

        <div class="mc-panel" id="goalPanel">
            <div style="font-size: 8px; color: #555; text-align: center; margin-bottom: 6px;">üéØ NASTƒòPNA NAGRODA üéØ</div>
            <div class="goal-panel" id="goalContent"></div>
        </div>

        <div class="mc-panel">
            <div class="question-area">
                <div class="question-text" id="question">? √ó ? = ?</div>
                <div class="mc-display active" id="answerDisplay"><span class="cursor">_</span></div>
                <div class="mc-numpad" id="numpad">
                    <button class="mc-numkey" onclick="numPress('1')">1</button>
                    <button class="mc-numkey" onclick="numPress('2')">2</button>
                    <button class="mc-numkey" onclick="numPress('3')">3</button>
                    <button class="mc-numkey" onclick="numPress('4')">4</button>
                    <button class="mc-numkey" onclick="numPress('5')">5</button>
                    <button class="mc-numkey" onclick="numPress('6')">6</button>
                    <button class="mc-numkey" onclick="numPress('7')">7</button>
                    <button class="mc-numkey" onclick="numPress('8')">8</button>
                    <button class="mc-numkey" onclick="numPress('9')">9</button>
                    <button class="mc-numkey key-del" onclick="numPress('del')">‚å´</button>
                    <button class="mc-numkey key-0" onclick="numPress('0')">0</button>
                    <button class="mc-numkey key-ok" onclick="numPress('ok')">‚úî</button>
                </div>
                <div class="hint-row">
                    <button class="mc-btn hint-btn" id="hintBlocksBtn" onclick="showHint('blocks')">üß± Bloczki</button>
                    <button class="mc-btn hint-btn" id="hintSkipBtn" onclick="showHint('skip')">üî¢ Licz co...</button>
                    <button class="mc-btn hint-btn" id="hintNearbyBtn" onclick="showHint('nearby')">üìñ Blisko!</button>
                </div>
                <div class="hint-cost" id="hintCost">Podpowied≈∫ = mniej üíé, ale wiƒôcej wiedzy!</div>
                <div class="feedback" id="feedback"></div>
                <div class="visual-hint" id="visualHint"></div>
                <div class="wrong-explain" id="wrongExplain"></div>
                <div id="continueRow" style="display:none; margin-top: 12px;">
                    <button class="mc-btn primary" id="continueBtn" onclick="continueAfterWrong()" style="font-size: 11px; padding: 10px 24px;">‚ñ∂ ROZUMIEM, DALEJ!</button>
                </div>
            </div>
        </div>

        <div class="mc-panel">
            <div style="font-size: 8px; color: #555; text-align: center; margin-bottom: 6px;">üèÜ TROFEA üèÜ</div>
            <div class="trophy-shelf" id="trophyShelf"></div>
        </div>

        <div class="mc-panel">
            <div style="font-size: 8px; color: #555; text-align: center; margin-bottom: 6px;">‚öîÔ∏è EKWIPUNEK ‚öîÔ∏è</div>
            <div class="inventory" id="inventory"></div>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameoverScreen" class="screen">
        <div class="mc-panel gameover-screen">
            <h2>üèÅ KONIEC GRY!</h2>
            <div class="final-stats" id="finalStats"></div>
            <div class="leaderboard" id="gameoverLeaderboard"></div>
            <div class="loot-summary" id="lootSummary"></div>
            <div class="mistakes-review" id="mistakesReview"></div>
            <div class="mastery-section" id="masterySection"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="mc-btn primary" onclick="startGame()">üîÑ JESZCZE RAZ</button>
                <button class="mc-btn" onclick="practiceWeakSpots()">üéØ ƒÜWICZ B≈ÅƒòDY</button>
                <button class="mc-btn" onclick="showScreen('catalogScreen')">üß† BRAINROTY</button>
                <button class="mc-btn" onclick="showScreen('startScreen')">üè† MENU</button>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD -->
    <div id="leaderboardScreen" class="screen">
        <div class="mc-panel">
            <h2 style="font-size:14px;color:#333;text-align:center;margin-bottom:16px;">üèÜ RANKING üèÜ</h2>
            <div class="difficulty" style="margin-bottom:12px;">
                <button class="diff-btn active" onclick="showLeaderboardTab('easy',this)">üòä ≈Åatwy</button>
                <button class="diff-btn" onclick="showLeaderboardTab('medium',this)">üòé ≈öredni</button>
                <button class="diff-btn" onclick="showLeaderboardTab('hard',this)">üíÄ Trudny</button>
            </div>
            <div id="leaderboardContent"></div>
            <div style="margin-top:16px;text-align:center;">
                <button class="mc-btn" onclick="showScreen('startScreen')">üè† MENU</button>
            </div>
        </div>
    </div>

    <!-- BRAINROT CATALOG -->
    <div id="catalogScreen" class="screen">
        <div class="mc-panel">
            <h2 style="font-size:14px;color:#333;text-align:center;margin-bottom:8px;">üß† KOLEKCJA BRAINROT üß†</h2>
            <div style="font-size:7px;color:#888;text-align:center;margin-bottom:12px;">Zdobywaj punkty aby odblokowaƒá postacie!</div>
            <div id="catalogContent" class="brainrot-grid"></div>
            <div style="margin-top:16px;text-align:center;">
                <button class="mc-btn" onclick="showScreen('startScreen')">üè† MENU</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Minecraft Items Database
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const MC_ITEMS = {
        // Common drops
        cobblestone:  { icon: 'ü™®', name: 'Cobblestone',      rarity: 'common',    desc: 'Podstawowy blok' },
        wood:         { icon: 'ü™µ', name: 'Drewno',           rarity: 'common',    desc: 'Zawsze siƒô przyda' },
        coal:         { icon: 'ÔøΩite', name: 'Wƒôgiel',          rarity: 'common',    desc: 'Dobry na pochodnie' },
        iron:         { icon: 'üî©', name: '≈ªelazo',           rarity: 'common',    desc: 'Mocny metal' },
        apple:        { icon: 'üçé', name: 'Jab≈Çko',           rarity: 'common',    desc: '+1 ‚ù§Ô∏è ≈ºycia!' },
        bread:        { icon: 'üçû', name: 'Chleb',            rarity: 'common',    desc: 'Energia na dalszƒÖ grƒô' },
        // Uncommon
        gold_ingot:   { icon: 'ü•á', name: 'Sztabka z≈Çota',    rarity: 'uncommon',  desc: 'L≈õniƒÖce z≈Çoto' },
        lapis:        { icon: 'üîµ', name: 'Lapis Lazuli',     rarity: 'uncommon',  desc: 'Do zaklƒôƒá' },
        redstone:     { icon: 'üî¥', name: 'Redstone',         rarity: 'uncommon',  desc: 'Moc elektryczna!' },
        bow:          { icon: 'üèπ', name: '≈Åuk',              rarity: 'uncommon',  desc: 'Bro≈Ñ na dystans' },
        // Rare
        diamond:      { icon: 'üíé', name: 'Diament',          rarity: 'rare',      desc: 'Najcenniejszy kryszta≈Ç!' },
        emerald:      { icon: 'üíö', name: 'Szmaragd',         rarity: 'rare',      desc: 'Waluta u wie≈õniak√≥w' },
        ench_book:    { icon: 'üìñ', name: 'Ksiƒôga zaklƒôƒá',    rarity: 'rare',      desc: 'Magiczna wiedza' },
        golden_apple: { icon: 'üçè', name: 'Z≈Çote jab≈Çko',     rarity: 'rare',      desc: 'Pe≈Çne ≈ºycie!' },
        // Epic
        diamond_sword:{ icon: '‚öîÔ∏è', name: 'Diamentowy miecz', rarity: 'epic',      desc: 'Legendarny orƒô≈º!' },
        diamond_pick: { icon: '‚õèÔ∏è', name: 'Diamentowy kilof',  rarity: 'epic',      desc: 'Wykopie wszystko!' },
        elytra:       { icon: 'ü™Ω', name: 'Elytra',           rarity: 'epic',      desc: 'Mo≈ºesz lataƒá!' },
        trident:      { icon: 'üî±', name: 'Tr√≥jzƒÖb',          rarity: 'epic',      desc: 'Bro≈Ñ z oceanu!' },
        // Legendary
        nether_star:  { icon: '‚≠ê', name: 'Gwiazda Netheru',  rarity: 'legendary', desc: 'Z Withera! Ultra rzadka!' },
        dragon_egg:   { icon: 'ü•ö', name: 'Smocze jajo',      rarity: 'legendary', desc: 'Jedyne w ≈õwiecie!' },
        totem:        { icon: 'üóø', name: 'Totem nie≈õmiertelno≈õci', rarity: 'legendary', desc: 'Chroni przed ≈õmierciƒÖ!' },
        beacon:       { icon: 'üî¶', name: 'Beacon',           rarity: 'legendary', desc: '≈öwieci na ca≈Çy ≈õwiat!' },
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Brainrot Characters Database
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const BRAINROT_CHARS = [
        { id: 'tralalero',    name: 'Tralalero Tralala',        rarity: 'common',    desc: 'Rekin w adidasach, chodzi po lƒÖdzie',            goal: 15,  power: 'Shark dance',        catchphrase: 'Tralalero tralala!',        img: 'https://brainrots.icu/characters/Tralalero%20Tralala.webp' },
        { id: 'bombardiro',   name: 'Bombardiro Crocodilo',     rarity: 'common',    desc: 'Krokodyl-bombowiec, lata i bombarduje',          goal: 30,  power: 'Bombardowanie',      catchphrase: 'Bombardiro crocodilo!',     img: 'https://brainrots.icu/characters/Bombardino%20Crocodilo.jpg' },
        { id: 'trippi',       name: 'Trippi Troppi',            rarity: 'common',    desc: 'Tropikalny kole≈õ, zawsze na vibie',              goal: 50,  power: 'Tropical vibes',     catchphrase: 'Trippi troppi!',            img: 'https://brainrots.icu/characters/Trippi-Troppi.webp' },
        { id: 'tungtung',     name: 'Tung Tung Tung Sahur',     rarity: 'rare',      desc: 'Drewniana deska z twarzƒÖ, budzi na sahur',       goal: 80,  power: 'Tung attack',        catchphrase: 'Tung tung tung sahur!',     img: 'https://brainrots.icu/characters/Tung%20Tung%20Tung%20Tung%20Tung%20Tung%20Tung%20Sahur.webp' },
        { id: 'lirili',       name: 'Liril√¨ Laril√†',            rarity: 'rare',      desc: 'Tajemnicza postaƒá, ≈õpiewa dziwne melodie',       goal: 120, power: 'Hypno song',         catchphrase: 'Liril√¨ laril√†~!',          img: 'https://brainrots.icu/characters/Lirili%20Larila.jpg' },
        { id: 'boneca',       name: 'Boneca Ambalabu',          rarity: 'rare',      desc: 'Lalka z innego wymiaru, trochƒô creepy',          goal: 170, power: 'Cursed stare',       catchphrase: 'Ambalabu!',                 img: 'https://brainrots.icu/memes/640%20-%20%20-%202025-06-24%2015-22-15.webp' },
        { id: 'patapim',      name: 'Brr Brr Patapim',          rarity: 'epic',      desc: 'Ma≈Çpa-mech w zbroi, robi brr brr',              goal: 230, power: 'Mech mode',          catchphrase: 'Brr brr patapim!',          img: 'https://brainrots.icu/memes/640%20-%20%20-%202025-06-24%2015-22-12.webp' },
        { id: 'bombombini',   name: 'Bombombini Gusini',        rarity: 'epic',      desc: 'Gƒô≈õ z bombami, nie pytaj dlaczego',             goal: 300, power: 'Goose bomb',         catchphrase: 'Bombombini gusini!',        img: 'https://brainrots.icu/characters/Bombombini%20Gusini.jpg' },
        { id: 'chimpanzini',  name: 'Chimpanzini Bananini',     rarity: 'legendary', desc: 'W≈Çoski szympans z bananem, szef mafii bananowej', goal: 400, power: 'Banana barrage',    catchphrase: 'Chimpanzini bananini!',     img: 'https://brainrots.icu/characters/Chimpanzini%20Bananini.png' },
        { id: 'capuccino',    name: 'Capuccino Assassino',      rarity: 'god',       desc: 'Zab√≥jcze cappuccino, ostateczny boss brainrotu', goal: 600, power: 'Espresso kill shot', catchphrase: 'Capuccino... assassino!',   img: 'https://brainrots.icu/memes/640%20-%20%20-%202025-06-24%2015-22-08.webp' },
    ];

    function getBrainrotCollection() {
        try { return JSON.parse(localStorage.getItem('mc_brainrot_collection') || '{}'); } catch(e) { return {}; }
    }
    function saveBrainrotCollection(col) {
        localStorage.setItem('mc_brainrot_collection', JSON.stringify(col));
    }

    // Loot tables based on speed and streak
    const LOOT_TABLES = {
        lightning: { // < 2s
            common: 0.05, uncommon: 0.15, rare: 0.40, epic: 0.30, legendary: 0.10
        },
        fast: { // < 4s
            common: 0.10, uncommon: 0.30, rare: 0.35, epic: 0.20, legendary: 0.05
        },
        good: { // < 8s
            common: 0.25, uncommon: 0.35, rare: 0.25, epic: 0.12, legendary: 0.03
        },
        ok: { // >= 8s or hint
            common: 0.50, uncommon: 0.30, rare: 0.15, epic: 0.04, legendary: 0.01
        }
    };

    const SPEED_LABELS = {
        lightning: { label: '‚ö° B≈ÅYSKAWICA!', cls: 'lightning', points: 5 },
        fast:      { label: 'üèÉ Szybko!',      cls: 'fast',      points: 3 },
        good:      { label: 'üëç Dobrze',        cls: 'good',      points: 2 },
        ok:        { label: 'üê¢ Powoli...',     cls: 'ok',        points: 1 },
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Game State
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ROUND_TIME = 120; // 2 minutes in seconds

    let state = {
        difficulty: 'easy', score: 0, xp: 0, level: 1, xpToNext: 100,
        correct: 0, total: 0,
        streak: 0, bestStreak: 0, combo: 1,
        a: 0, b: 0, answer: 0,
        timerInterval: null, timeLeft: 0, timerMax: 15,
        roundTimerInterval: null, roundTimeLeft: ROUND_TIME,
        achievements: new Set(), playing: false,
        hintUsed: false, hintsUsedTotal: 0,
        questionStartTime: 0,
        inventory: {},
        lootLog: [],
        mistakes: [], mistakeMap: {}, masteryMap: {},
        questionQueue: [], practiceMode: false, questionHistory: [],
        freshPool: [], askedSet: new Set(),
    };

    const diffSettings = {
        easy:   { min: 2, max: 5,  timer: false },
        medium: { min: 2, max: 10, timer: false },
        hard:   { min: 2, max: 12, timer: true, time: 15 }
    };

    const blockTypes = ['grass', 'dirt', 'stone', 'diamond', 'gold', 'wood'];

    const achievementList = [
        { id: 'first',      check: s => s.correct >= 1,          icon: '‚≠ê', title: 'Pierwszy krok!',      desc: 'Pierwsza poprawna odpowied≈∫',  progress: s => ({ cur: s.correct, max: 1, label: 'Poprawne' }) },
        { id: 'streak5',    check: s => s.streak >= 5,           icon: 'üî•', title: 'W ogniu!',            desc: 'Seria 5 poprawnych z rzƒôdu',   progress: s => ({ cur: s.streak, max: 5, label: 'Seria' }) },
        { id: 'dia10',      check: s => s.score >= 30,           icon: 'üíé', title: 'G√≥rnik diament√≥w!',   desc: 'ZdobƒÖd≈∫ 30 punkt√≥w',           progress: s => ({ cur: s.score, max: 30, label: 'Punkty' }) },
        { id: 'hint_learn', check: s => s.hintsUsedTotal >= 5,   icon: 'üìñ', title: 'Badacz!',             desc: 'U≈ºyj 5 podpowiedzi',           progress: s => ({ cur: s.hintsUsedTotal, max: 5, label: 'Podpowiedzi' }) },
        { id: 'perfect10',  check: s => s.correct >= 10 && s.correct === s.total, icon: 'üéØ', title: 'Perfekcja!', desc: '10 poprawnych bez b≈Çƒôdu', progress: s => ({ cur: s.correct === s.total ? s.correct : 0, max: 10, label: 'Bez b≈Çƒôdu' }) },
        { id: 'streak10',   check: s => s.streak >= 10,          icon: '‚ö°', title: 'Niepokonany!',        desc: 'Seria 10 poprawnych z rzƒôdu',  progress: s => ({ cur: s.streak, max: 10, label: 'Seria' }) },
        { id: 'fast_round', check: s => s.correct >= 5 && s.total === s.correct, icon: 'üí™', title: 'Nie poddajƒô siƒô!', desc: '5 poprawnych bez b≈Çƒôdu pod rzƒÖd', progress: s => ({ cur: s.correct === s.total ? s.correct : 0, max: 5, label: 'Czyste' }) },
        { id: 'lightning5',  check: s => s._lightningCount >= 5,  icon: '‚ö°', title: 'Prƒôdko≈õƒá ≈õwiat≈Ça!',  desc: '5 odpowiedzi poni≈ºej 2s',      progress: s => ({ cur: s._lightningCount || 0, max: 5, label: 'B≈Çyskawice' }) },
        { id: 'dia50',      check: s => s.score >= 100,          icon: 'üíé', title: 'Koparka diamentowa!', desc: 'ZdobƒÖd≈∫ 100 punkt√≥w',          progress: s => ({ cur: s.score, max: 100, label: 'Punkty' }) },
        { id: 'combo_x5',   check: s => s.combo >= 5,            icon: 'üí•', title: 'MEGA COMBO!',         desc: 'OsiƒÖgnij combo √ó5',            progress: s => ({ cur: s.combo, max: 5, label: 'Combo' }) },
        { id: 'lvl5',       check: s => s.level >= 5,            icon: 'üèÜ', title: 'Mistrz matematyki!',  desc: 'OsiƒÖgnij poziom 5',            progress: s => ({ cur: s.level, max: 5, label: 'Poziom' }) },
        { id: 'legendary',  check: s => s._hasLegendary,         icon: 'ü•ö', title: 'Legendarny ≈Çup!',    desc: 'ZdobƒÖd≈∫ legendarny przedmiot', progress: s => ({ cur: s._hasLegendary ? 1 : 0, max: 1, label: 'Legendarny' }) },
        { id: 'lvl10',      check: s => s.level >= 10,           icon: 'üëë', title: 'Legenda!',            desc: 'OsiƒÖgnij poziom 10',           progress: s => ({ cur: s.level, max: 10, label: 'Poziom' }) },
    ];

    const goodMessages = ['≈öwietnie! ‚õèÔ∏è','Brawo! üíé','Dobrze! ‚úÖ','Super! üåü','Genialnie! üî•','Tak trzymaj! üí™','Mistrz! üëë','Niesamowite! ‚ö°','Fantastycznie! üéâ','Wow! üèÜ'];
    const badMessages = ['Spr√≥buj ponownie!','Prawie!','Nie poddawaj siƒô!','ƒÜwicz dalej! üí™'];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Speed & Combo System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function getSpeedTier(ms) {
        if (ms < 2000) return 'lightning';
        if (ms < 4000) return 'fast';
        if (ms < 8000) return 'good';
        return 'ok';
    }

    function updateCombo(correct) {
        if (correct) {
            state.streak++;
            if (state.streak > state.bestStreak) state.bestStreak = state.streak;
            // Combo grows every 3 correct, max 5
            state.combo = Math.min(5, 1 + Math.floor(state.streak / 3));
        } else {
            state.streak = 0;
            state.combo = 1;
        }
        renderCombo();
    }

    function renderCombo() {
        const el = document.getElementById('comboContainer');
        if (state.combo >= 2) {
            const cls = state.combo >= 5 ? 'x5' : state.combo >= 4 ? 'x4' : state.combo >= 3 ? 'x3' : 'x2';
            const pct = ((state.streak % 3) / 3) * 100;
            const nextCombo = state.combo < 5 ? ` ‚Üí √ó${state.combo + 1}` : ' MAX!';
            el.innerHTML = `
                <div class="combo-text ${cls}">üî• COMBO √ó${state.combo} üî•</div>
                <div class="combo-bar-bg"><div class="combo-bar-fill" style="width:${state.combo >= 5 ? 100 : pct}%;background:${
                    state.combo >= 5 ? '#FF4444' : state.combo >= 4 ? '#FF00FF' : state.combo >= 3 ? '#FCDB05' : '#5DECF5'
                }"></div></div>
            `;
        } else if (state.streak > 0) {
            const pct = (state.streak / 3) * 100;
            el.innerHTML = `
                <div style="font-size:8px;color:#888;">seria: ${state.streak} (combo za ${3 - state.streak}...)</div>
                <div class="combo-bar-bg"><div class="combo-bar-fill" style="width:${pct}%;background:#888"></div></div>
            `;
        } else {
            el.innerHTML = '';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Loot System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function rollLoot(speedTier) {
        const table = LOOT_TABLES[speedTier];
        const roll = Math.random();
        let rarity;
        let cumul = 0;
        for (const [r, chance] of Object.entries(table)) {
            cumul += chance;
            if (roll <= cumul) { rarity = r; break; }
        }
        if (!rarity) rarity = 'common';

        // Combo bonus: extra roll chance for better rarity
        if (state.combo >= 3 && rarity === 'common') rarity = 'uncommon';
        if (state.combo >= 5 && rarity === 'uncommon' && Math.random() < 0.5) rarity = 'rare';

        // Pick random item of that rarity
        const candidates = Object.entries(MC_ITEMS).filter(([_, v]) => v.rarity === rarity);
        const [itemKey, item] = candidates[Math.floor(Math.random() * candidates.length)];

        // Add to inventory
        state.inventory[itemKey] = (state.inventory[itemKey] || 0) + 1;
        state.lootLog.push({ itemKey, rarity });

        if (rarity === 'legendary') state._hasLegendary = true;

        return { itemKey, item };
    }

    function spawnLootDrop(item) {
        const el = document.createElement('div');
        el.className = 'loot-drop';
        el.textContent = item.icon;
        el.style.left = (window.innerWidth / 2 + (Math.random() - 0.5) * 150) + 'px';
        el.style.top = (window.innerHeight / 2 - 50) + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function spawnFloatScore(points, speedTier, x, y) {
        const el = document.createElement('div');
        el.className = 'float-score';
        const colors = { lightning: '#FCDB05', fast: '#5DECF5', good: '#17DD62', ok: '#aaa' };
        el.style.color = colors[speedTier];
        el.textContent = `+${points}`;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1200);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Core Functions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setDifficulty(diff, btn) {
        state.difficulty = diff;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === 'leaderboardScreen') {
            showLeaderboardTab(currentLbTab || 'easy');
        } else if (id === 'catalogScreen') {
            renderCatalog();
        }
    }

    function startGame() {
        const nameInput = document.getElementById('playerName');
        const name = (nameInput.value || '').trim() || 'Gracz';
        state.playerName = name;
        localStorage.setItem('mc_tabliczka_name', name);

        const settings = diffSettings[state.difficulty];
        clearInterval(state.roundTimerInterval);
        clearInterval(state.timerInterval);
        Object.assign(state, {
            score: 0, xp: 0, level: 1, xpToNext: 100,
            correct: 0, total: 0,
            streak: 0, bestStreak: 0, combo: 1,
            playing: true, hintUsed: false, hintsUsedTotal: 0,
            inventory: {}, lootLog: [],
            mistakes: [], mistakeMap: {}, masteryMap: {},
            questionQueue: [], practiceMode: false, questionHistory: [],
            freshPool: [], askedSet: new Set(),
            roundTimeLeft: ROUND_TIME,
            _lightningCount: 0, _hasLegendary: false, _newTrophies: null,
            _mistakePracticeCount: {}, _waitingForContinue: false,
        });
        buildFreshPool();

        if (settings.timer) {
            state.timerMax = settings.time;
            document.getElementById('timerSection').classList.add('visible');
        } else {
            document.getElementById('timerSection').classList.remove('visible');
        }

        updateUI();
        showScreen('gameScreen');
        startRoundTimer();
        nextQuestion();
    }

    function startRoundTimer() {
        state.roundTimeLeft = ROUND_TIME;
        updateRoundTimerDisplay();
        state.roundTimerInterval = setInterval(() => {
            state.roundTimeLeft -= 0.5;
            if (state.roundTimeLeft <= 0) {
                state.roundTimeLeft = 0;
                clearInterval(state.roundTimerInterval);
                clearInterval(state.timerInterval);
                state.playing = false;
                showGameOver();
                return;
            }
            updateRoundTimerDisplay();
        }, 500);
    }

    function updateRoundTimerDisplay() {
        const t = Math.max(0, Math.ceil(state.roundTimeLeft));
        const min = Math.floor(t / 60);
        const sec = t % 60;
        const timerEl = document.getElementById('mainTimer');
        timerEl.textContent = `‚è±Ô∏è ${min}:${sec.toString().padStart(2, '0')}`;
        timerEl.className = 'main-timer' + (t <= 30 ? ' warning' : '');

        const pct = (state.roundTimeLeft / ROUND_TIME) * 100;
        const bar = document.getElementById('mainTimerBar');
        bar.style.width = pct + '%';
        bar.className = 'main-timer-bar-fill' + (pct < 15 ? ' critical' : pct < 33 ? ' low' : '');
    }

    function buildFreshPool() {
        const settings = diffSettings[state.difficulty];
        state.freshPool = [];
        // Include BOTH orderings (a√ób AND b√óa) for more variety
        for (let a = settings.min; a <= settings.max; a++) {
            for (let b = settings.min; b <= settings.max; b++) {
                state.freshPool.push({ a, b });
            }
        }
        shuffle(state.freshPool);
        state.askedSet = new Set();
    }

    function pullFromPool() {
        if (state.freshPool.length > 0) {
            return state.freshPool.shift();
        }
        // Pool exhausted - rebuild (all pairs seen, start fresh cycle)
        rebuildExhaustedPool();
        if (state.freshPool.length > 0) {
            return state.freshPool.shift();
        }
        const s = diffSettings[state.difficulty];
        return { a: randInt(s.min, s.max), b: randInt(s.min, s.max) };
    }

    function rebuildExhaustedPool() {
        // All pairs asked once - rebuild with both orderings again
        const settings = diffSettings[state.difficulty];
        state.freshPool = [];
        for (let a = settings.min; a <= settings.max; a++) {
            for (let b = settings.min; b <= settings.max; b++) {
                state.freshPool.push({ a, b });
            }
        }
        shuffle(state.freshPool);
    }

    function practiceWeakSpots() {
        const weakPairs = Object.entries(state.mistakeMap).filter(([_, c]) => c > 0);
        if (weakPairs.length === 0) { startGame(); return; }

        clearInterval(state.roundTimerInterval);
        clearInterval(state.timerInterval);
        Object.assign(state, {
            score: 0, xp: 0, level: 1, xpToNext: 100,
            correct: 0, total: 0,
            streak: 0, bestStreak: 0, combo: 1,
            playing: true, hintUsed: false,
            practiceMode: true, questionHistory: [],
            inventory: {}, lootLog: [],
            roundTimeLeft: ROUND_TIME,
            _lightningCount: 0, _hasLegendary: false, _newTrophies: null,
            _mistakePracticeCount: {}, _waitingForContinue: false,
        });

        // Each mistake repeated max 2 times, then mix in fresh questions
        state.questionQueue = [];
        for (const [key, count] of Object.entries(state.mistakeMap)) {
            if (count > 0) {
                const [a, b] = key.split('√ó').map(Number);
                // Max 2 repeats per mistake
                state.questionQueue.push({ a, b });
                state.questionQueue.push({ a, b });
                state._mistakePracticeCount[key] = 0;
            }
        }
        // Add fresh questions so it's not only mistakes (mix ~50/50)
        const freshCount = Math.max(4, state.questionQueue.length);
        buildFreshPool();
        for (let i = 0; i < freshCount && state.freshPool.length > 0; i++) {
            const q = state.freshPool.shift();
            const key = `${q.a}√ó${q.b}`;
            // Don't add if it's already a mistake question
            if (!state.mistakeMap[key] && !state.mistakeMap[`${q.b}√ó${q.a}`]) {
                state.questionQueue.push(q);
            }
        }
        shuffle(state.questionQueue);

        document.getElementById('timerSection').classList.remove('visible');
        updateUI(); showScreen('gameScreen');
        startRoundTimer();
        showAchievement('üéØ', 'Tryb ƒáwicze≈Ñ!', 'B≈Çƒôdy + nowe zadania');
        nextQuestion();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Question Selection
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function nextQuestion() {
        hideHints();
        state.hintUsed = false;

        let a, b;
        if (state.practiceMode && state.questionQueue.length > 0) {
            const q = state.questionQueue.shift();
            a = q.a; b = q.b;
        }
        // In normal mode: only pull from pool (no repeats unless wrong answer re-added it)
        if (!a || !b) { const q = pullFromPool(); a = q.a; b = q.b; }

        state.a = a; state.b = b; state.answer = a * b;
        state.askedSet.add(masteryKey(a, b));
        state.questionHistory.push(`${a}√ó${b}`);
        if (state.questionHistory.length > 5) state.questionHistory.shift();

        const key = masteryKey(a, b);
        if (!state.masteryMap[key]) state.masteryMap[key] = { correct: 0, total: 0, streak: 0 };

        document.getElementById('question').textContent = `${a} √ó ${b} = ?`;
        numpadValue = '';
        updateDisplay();
        document.getElementById('answerDisplay').className = 'mc-display active';
        state._waitingForContinue = false;
        document.getElementById('feedback').textContent = '';
        document.getElementById('hintCost').textContent = 'Podpowied≈∫ = mniej üíé, ale wiƒôcej wiedzy!';

        // Start measuring answer time
        state.questionStartTime = Date.now();

        const settings = diffSettings[state.difficulty];
        if (settings.timer) startTimer();
        if (state.practiceMode && state.questionQueue.length === 0) state.practiceMode = false;
    }

    function getRepeatChance() {
        const totalMistakes = Object.values(state.mistakeMap).reduce((s, v) => s + v, 0);
        return Math.min(0.6, 0.2 + totalMistakes * 0.05);
    }

    function getWeakestQuestion() {
        const entries = Object.entries(state.mistakeMap).filter(([_, c]) => c > 0);
        if (entries.length === 0) return null;
        const totalWeight = entries.reduce((s, [_, c]) => s + c, 0);
        let r = Math.random() * totalWeight;
        for (const [key, count] of entries) {
            r -= count;
            if (r <= 0) {
                const [a, b] = key.split('√ó').map(Number);
                if (!isRecentQuestion(a, b)) return { a, b };
            }
        }
        const [key] = entries[0];
        const [a, b] = key.split('√ó').map(Number);
        return { a, b };
    }

    function isRecentQuestion(a, b) {
        return state.questionHistory.includes(`${a}√ó${b}`) || state.questionHistory.includes(`${b}√ó${a}`);
    }

    function masteryKey(a, b) { return `${Math.min(a,b)}√ó${Math.max(a,b)}`; }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Hint System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showHint(type) {
        if (!state.playing) return;
        if (!state.hintUsed) { state.hintUsed = true; state.hintsUsedTotal++; }
        document.querySelectorAll('.hint-btn').forEach(b => b.classList.remove('hint-active'));
        const btnMap = { blocks: 'hintBlocksBtn', skip: 'hintSkipBtn', nearby: 'hintNearbyBtn' };
        document.getElementById(btnMap[type]).classList.add('hint-active');
        const hint = document.getElementById('visualHint');
        hint.innerHTML = ''; hint.classList.add('show');
        document.getElementById('hintCost').textContent = 'üìñ Podpowied≈∫ u≈ºyta (mniej punkt√≥w) ‚Äî klikaj inne aby por√≥wnaƒá!';
        if (type === 'blocks') buildBlocksHint(hint);
        else if (type === 'skip') buildSkipCountHint(hint);
        else if (type === 'nearby') buildNearbyHint(hint);
        checkAchievements();
    }

    function buildBlocksHint(container) {
        const a = state.a, b = state.b;
        const bt = blockTypes[Math.floor(Math.random() * blockTypes.length)];
        container.innerHTML = `<div class="hint-title">üß± WIZUALIZACJA: ${a} √ó ${b}</div><div class="hint-explanation">${a} √ó ${b} oznacza: ${a} rzƒôd√≥w po ${b} bloczk√≥w</div><div class="grid-label">${a} rzƒôdy ‚Üì √ó ${b} kolumny ‚Üí</div><div id="blockGrid" class="block-grid" style="grid-template-columns: repeat(${b}, 22px);"></div><div class="grid-result" id="gridResult"></div>`;
        const grid = document.getElementById('blockGrid');
        const total = a * b; let count = 0;
        for (let i = 0; i < a; i++) { for (let j = 0; j < b; j++) { count++;
            const block = document.createElement('div'); block.className = `mc-block ${bt}`;
            const delay = count * 60, cc = count; block.style.opacity = '0'; grid.appendChild(block);
            setTimeout(() => { block.classList.add('highlight'); block.style.opacity = '1';
                document.getElementById('gridResult').textContent = cc === total ? `= ${total} bloczk√≥w! ‚úÖ` : `${cc} / ${total}...`; }, delay);
        }}
    }

    function buildSkipCountHint(container) {
        const a = state.a, b = state.b;
        container.innerHTML = `<div class="hint-title">üî¢ LICZENIE CO ${b}</div><div class="hint-explanation">${a} √ó ${b} = dodaj ${b} do siebie ${a} razy:</div><div class="skip-count" id="skipCount"></div><div class="grid-result" id="skipResult"></div>`;
        const sd = document.getElementById('skipCount');
        for (let i = 1; i <= a; i++) { const n = document.createElement('div'); n.className = 'skip-num hidden'; n.textContent = i * b; sd.appendChild(n); }
        for (let i = 1; i <= a; i++) { setTimeout(() => { const el = sd.children[i-1]; el.classList.remove('hidden'); el.classList.add(i === a ? 'answer-num' : 'revealed');
            const l = []; for (let j = 1; j <= i; j++) l.push(b);
            document.getElementById('skipResult').textContent = i === a ? `${l.join(' + ')} = ${i*b} ‚úÖ` : `${l.join(' + ')} = ${i*b}`; }, i * 400); }
    }

    function buildNearbyHint(container) {
        const a = state.a, b = state.b;
        const facts = [];
        if (a > 1) facts.push({ a: a-1, b, result: (a-1)*b, current: false });
        facts.push({ a, b, result: a*b, current: true });
        if (a <= 12) facts.push({ a: a+1, b, result: (a+1)*b, current: false });
        container.innerHTML = `<div class="hint-title">üìñ SƒÑSIEDNIE DZIA≈ÅANIA</div><div class="hint-explanation">Je≈õli znasz sƒÖsiednie mno≈ºenia,<br>wystarczy dodaƒá lub odjƒÖƒá ${b}!</div><div class="nearby-facts" id="nearbyFacts"></div><div class="hint-explanation" style="margin-top:8px;color:var(--diamond);">${a > 1 ? `${a-1} √ó ${b} = ${(a-1)*b}, wiƒôc dodaj ${b}...` : `1 √ó ${b} = ${b}, zacznij od tego!`}</div>`;
        const fd = document.getElementById('nearbyFacts');
        facts.forEach((f, i) => { setTimeout(() => { const el = document.createElement('div'); el.className = 'nearby-fact' + (f.current ? ' current' : '');
            el.innerHTML = f.current ? `${f.a} √ó ${f.b} <span class="op">=</span> <strong>?</strong>` : `${f.a} √ó ${f.b} <span class="op">=</span> ${f.result}`;
            fd.appendChild(el); }, i * 300); });
    }

    function showWrongHint(type) {
        const hint = document.getElementById('visualHint'); hint.innerHTML = ''; hint.classList.add('show');
        if (type === 'blocks') buildBlocksHint(hint); else if (type === 'skip') buildSkipCountHint(hint); else if (type === 'nearby') buildNearbyHint(hint);
    }

    function hideHints() {
        document.getElementById('visualHint').classList.remove('show');
        document.getElementById('visualHint').innerHTML = '';
        document.getElementById('wrongExplain').classList.remove('show');
        document.getElementById('wrongExplain').innerHTML = '';
        document.getElementById('continueRow').style.display = 'none';
        document.querySelectorAll('.hint-btn').forEach(b => { b.classList.remove('hint-active'); b.disabled = false; });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Answer Handling
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function startTimer() {
        clearInterval(state.timerInterval); state.timeLeft = state.timerMax; updateTimerBar();
        state.timerInterval = setInterval(() => {
            state.timeLeft -= 0.1;
            if (state.timeLeft <= 0) {
                state.timeLeft = 0; clearInterval(state.timerInterval);
                if (state.playing) handleWrong();
            }
            updateTimerBar();
        }, 100);
    }

    function updateTimerBar() {
        const pct = (state.timeLeft / state.timerMax) * 100;
        const bar = document.getElementById('timerBar');
        bar.style.width = pct + '%';
        bar.className = 'timer-bar-fill' + (pct < 30 ? ' warning' : '');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Numpad System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let numpadValue = '';

    function updateDisplay() {
        const display = document.getElementById('answerDisplay');
        if (numpadValue === '') {
            display.innerHTML = '<span class="cursor">_</span>';
        } else {
            display.textContent = numpadValue;
        }
    }

    function numPress(key) {
        if (!state.playing) return;
        if (state._waitingForContinue) {
            if (key === 'ok') continueAfterWrong();
            return;
        }

        if (key === 'del') {
            numpadValue = numpadValue.slice(0, -1);
            updateDisplay();
        } else if (key === 'ok') {
            checkAnswer();
        } else {
            // digit 0-9, max 3 digits
            if (numpadValue.length < 3) {
                numpadValue += key;
                updateDisplay();
            }
        }
    }

    function handleKeyboard(event) {
        if (!state.playing) return;
        if (event.key === 'Enter' && state._waitingForContinue) {
            event.preventDefault();
            continueAfterWrong();
            return;
        }
        if (event.key === 'Enter') {
            event.preventDefault();
            checkAnswer();
        } else if (event.key === 'Backspace') {
            event.preventDefault();
            numpadValue = numpadValue.slice(0, -1);
            updateDisplay();
        } else if (event.key >= '0' && event.key <= '9') {
            event.preventDefault();
            if (numpadValue.length < 3) {
                numpadValue += event.key;
                updateDisplay();
            }
        }
    }

    // Physical keyboard support (desktop)
    document.addEventListener('keydown', (e) => {
        if (!state.playing || state._waitingForContinue) return;
        // Don't capture if typing in name field
        if (document.activeElement && document.activeElement.id === 'playerName') return;
        handleKeyboard(e);
    });

    function checkAnswer() {
        if (!state.playing) return;
        const val = parseInt(numpadValue);
        if (isNaN(val) || numpadValue === '') return;
        clearInterval(state.timerInterval);
        state.total++;
        const key = masteryKey(state.a, state.b);
        state.masteryMap[key].total++;

        const display = document.getElementById('answerDisplay');
        if (val === state.answer) handleCorrect(display);
        else handleWrong(display, val);
    }

    function handleCorrect(display) {
        if (display) display.className = 'mc-display correct';
        state.correct++;

        const key = masteryKey(state.a, state.b);
        state.masteryMap[key].correct++;
        state.masteryMap[key].streak++;

        const mKey = `${state.a}√ó${state.b}`;
        if (state.mistakeMap[mKey] && state.mistakeMap[mKey] > 0) state.mistakeMap[mKey]--;

        // Speed calculation
        const answerTime = Date.now() - state.questionStartTime;
        const speedTier = state.hintUsed ? 'ok' : getSpeedTier(answerTime);
        const speedInfo = SPEED_LABELS[speedTier];

        if (speedTier === 'lightning') state._lightningCount = (state._lightningCount || 0) + 1;

        // Update combo
        updateCombo(true);

        // Points: speed √ó combo
        const basePoints = speedInfo.points;
        const points = basePoints * state.combo;
        state.score += points;

        // XP
        const xpGain = state.hintUsed ? 8 : (10 + basePoints * 3 + state.combo * 2);
        state.xp += xpGain;
        while (state.xp >= state.xpToNext) {
            state.xp -= state.xpToNext;
            state.level++;
            state.xpToNext = Math.floor(100 * Math.pow(1.3, state.level - 1));
            showAchievement('‚¨ÜÔ∏è', 'Nowy poziom!', `OsiƒÖgnƒÖ≈Çe≈õ poziom ${state.level}!`);
            grantLevelReward();
        }

        // Loot drop!
        const loot = rollLoot(speedTier);
        spawnLootDrop(loot.item);

        // Floating score
        spawnFloatScore(points, speedTier, window.innerWidth / 2 - 20, window.innerHeight / 2 - 80);

        // Feedback
        const fb = document.getElementById('feedback');
        fb.className = 'feedback good';
        let msg;
        if (state.hintUsed) {
            msg = `Dobrze! Zapamiƒôtaj: ${state.a}√ó${state.b}=${state.answer} üìñ`;
        } else {
            msg = `${speedInfo.label} +${points}üíé`;
            if (state.combo >= 2) msg += ` (√ó${state.combo} combo!)`;
            msg += ` ‚Üí ${loot.item.icon} ${loot.item.name}`;
        }
        fb.textContent = msg;

        spawnParticles(speedTier === 'lightning' ? 16 : speedTier === 'fast' ? 10 : 6,
            ['#5DECF5', '#17DD62', '#FCDB05', '#FF00FF']);

        checkAchievements();
        updateUI();
        setTimeout(nextQuestion, state.hintUsed ? 2500 : 1000);
    }

    function handleWrong(display, wrongVal) {
        if (display) display.className = 'mc-display wrong';

        const key = masteryKey(state.a, state.b);
        state.masteryMap[key].streak = 0;

        const mKey = `${state.a}√ó${state.b}`;
        // Track practice count - only add to repeat queue if practiced < 2 times this session
        if (!state._mistakePracticeCount) state._mistakePracticeCount = {};
        const practiceCount = state._mistakePracticeCount[mKey] || 0;
        if (practiceCount < 2) {
            state.mistakeMap[mKey] = (state.mistakeMap[mKey] || 0) + 1;
            state._mistakePracticeCount[mKey] = practiceCount + 1;
        }
        // Otherwise it was already repeated enough - don't keep adding

        const existing = state.mistakes.find(m => m.a === state.a && m.b === state.b);
        if (existing) { existing.count++; existing.lastWrong = wrongVal; }
        else { state.mistakes.push({ a: state.a, b: state.b, correctAnswer: state.answer, lastWrong: wrongVal, count: 1 }); }

        updateCombo(false);

        // Re-add this question to freshPool so it repeats (wrong answer = re-ask)
        state.freshPool.unshift({ a: state.a, b: state.b });

        const fb = document.getElementById('feedback');
        fb.className = 'feedback bad';
        fb.textContent = badMessages[Math.floor(Math.random() * badMessages.length)];

        spawnParticles(4, ['#FF0000', '#CC0000', '#880000']);
        showWrongExplanation(wrongVal);

        state._waitingForContinue = true;
        document.querySelectorAll('.hint-btn').forEach(b => b.disabled = true);
        const contRow = document.getElementById('continueRow');
        contRow.style.display = 'block';
        document.getElementById('continueBtn').textContent = '‚ñ∂ ROZUMIEM, DALEJ!';

        updateUI();
    }

    function continueAfterWrong() {
        document.getElementById('continueRow').style.display = 'none';
        state._waitingForContinue = false;
        if (!state.playing) { showGameOver(); return; }
        nextQuestion();
    }

    function showWrongExplanation(wrongVal) {
        const el = document.getElementById('wrongExplain');
        const a = state.a, b = state.b, correct = state.answer;
        const bt = blockTypes[Math.floor(Math.random() * blockTypes.length)];
        const addParts = []; for (let i = 0; i < a; i++) addParts.push(b);
        const addStr = addParts.join(' + ');
        let relateStr = '';
        if (a > 1) relateStr = `<br>üìñ ${a-1} √ó ${b} = ${(a-1)*b}, dodaj jeszcze ${b} ‚Üí <strong>${correct}</strong>`;
        if (a === 2) relateStr = `<br>üìñ ${a} √ó ${b} to po prostu ${b} + ${b} = <strong>${correct}</strong>`;
        if (b === 10) relateStr = `<br>üìñ √ó 10 = dopisz zero! ${a}0 = <strong>${correct}</strong>`;
        if (b === 5) relateStr = `<br>üìñ √ó 5: to po≈Çowa z √ó 10. ${a}√ó10=${a*10}, podziel na 2 ‚Üí <strong>${correct}</strong>`;
        if (a === b) relateStr = `<br>üìñ ${a}¬≤ (kwadrat ${a}) = <strong>${correct}</strong> ‚Äî zapamiƒôtaj!`;
        let gridHTML = '';
        if (a * b <= 60) {
            gridHTML = `<div class="block-grid" style="grid-template-columns:repeat(${b},18px);margin:8px auto;display:inline-grid;">`;
            for (let i = 0; i < a * b; i++) gridHTML += `<div class="mc-block ${bt}" style="width:18px;height:18px;"></div>`;
            gridHTML += '</div>';
        }
        el.innerHTML = `
            <div class="explain-title">üìö NAUKA: ${a} √ó ${b} = ${correct}</div>
            <div class="explain-text">
                ${wrongVal !== undefined ? `Twoja odpowied≈∫: <span style="color:#FF6666;text-decoration:line-through;">${wrongVal}</span><br>` : 'Czas minƒÖ≈Ç!<br>'}
                Poprawna: <strong style="color:var(--emerald);font-size:14px;">${correct}</strong><br><br>
                üî¢ ${a} √ó ${b} = ${addStr} = <strong>${correct}</strong>${relateStr}
            </div>${gridHTML}
            <div style="font-size:7px;color:#888;margin-top:8px;">üí° To pytanie pojawi siƒô jeszcze raz!</div>
            <div style="margin-top:10px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap;">
                <button class="mc-btn hint-btn" style="font-size:8px;padding:5px 10px;" onclick="showWrongHint('blocks')">üß± Bloczki</button>
                <button class="mc-btn hint-btn" style="font-size:8px;padding:5px 10px;" onclick="showWrongHint('skip')">üî¢ Licz co...</button>
                <button class="mc-btn hint-btn" style="font-size:8px;padding:5px 10px;" onclick="showWrongHint('nearby')">üìñ Blisko!</button>
            </div>`;
        el.classList.add('show');
    }

    function grantLevelReward() {
        // Level up: guaranteed rare+ item
        const rarity = state.level % 5 === 0 ? 'legendary' : state.level % 3 === 0 ? 'epic' : 'rare';
        const candidates = Object.entries(MC_ITEMS).filter(([_, v]) => v.rarity === rarity);
        const [itemKey, item] = candidates[Math.floor(Math.random() * candidates.length)];
        state.inventory[itemKey] = (state.inventory[itemKey] || 0) + 1;
        state.lootLog.push({ itemKey, rarity });
        if (rarity === 'legendary') state._hasLegendary = true;
        spawnLootDrop(item);
        showAchievement(item.icon, `Nagroda za poziom ${state.level}!`, item.name);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Game Over
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showGameOver() {
        clearInterval(state.roundTimerInterval);
        clearInterval(state.timerInterval);
        state.playing = false;

        const pct = state.total > 0 ? Math.round((state.correct / state.total) * 100) : 0;
        const savedName = saveToLeaderboard(state.difficulty, state.playerName, state.score, state.level, pct);

        // Check brainrot unlocks
        const brainrotUnlocked = checkBrainrotUnlocks(state.score);

        let brainrotHTML = '';
        if (brainrotUnlocked.length > 0) {
            brainrotHTML = '<br>üß† Nowe brainroty: <span class="val">' + brainrotUnlocked.map(b => `<img src="${b.img}" style="width:24px;height:24px;border-radius:4px;vertical-align:middle;"> ${b.name}`).join(', ') + '</span>';
        }

        document.getElementById('finalStats').innerHTML = `
            üë§ Gracz: <span class="val">${savedName}</span><br>
            üíé Punkty: <span class="val">${state.score}</span><br>
            ‚úÖ Poprawne: <span class="val">${state.correct} / ${state.total} (${pct}%)</span><br>
            üî• Najlepsza seria: <span class="val">${state.bestStreak}</span><br>
            üí• Max combo: <span class="val">√ó${Math.min(5, 1 + Math.floor(state.bestStreak / 3))}</span><br>
            ‚¨ÜÔ∏è Poziom: <span class="val">${state.level}</span><br>
            üèÜ OsiƒÖgniƒôcia: <span class="val">${state.achievements.size}</span>${brainrotHTML}
        `;

        // Leaderboard on game over
        const diffLabel = { easy: 'üòä ≈Åatwy', medium: 'üòé ≈öredni', hard: 'üíÄ Trudny' };
        document.getElementById('gameoverLeaderboard').innerHTML =
            '<h3>üèÜ RANKING (' + diffLabel[state.difficulty] + '):</h3>' +
            renderLeaderboard(state.difficulty, savedName);

        // Loot summary
        buildLootSummary();

        // Mistakes
        const reviewEl = document.getElementById('mistakesReview');
        if (state.mistakes.length > 0) {
            let html = '<h3>‚ùå B≈ÅƒòDY DO POWT√ìRZENIA:</h3>';
            const sorted = [...state.mistakes].sort((a, b) => b.count - a.count);
            for (const m of sorted) {
                html += `<div class="mistake-item"><span class="mistake-q">${m.a} √ó ${m.b}</span><span class="mistake-wrong">‚úó ${m.lastWrong !== undefined ? m.lastWrong : '‚è∞'}</span><span class="mistake-right">‚úì ${m.correctAnswer}</span><span class="mistake-count">√ó${m.count}</span></div>`;
            }
            html += '<div style="font-size:7px;color:#aaa;text-align:center;margin-top:8px;">Kliknij "üéØ ƒÜWICZ B≈ÅƒòDY" aby powt√≥rzyƒá!</div>';
            reviewEl.innerHTML = html;
        } else {
            reviewEl.innerHTML = '<div style="text-align:center;font-size:9px;color:var(--emerald);margin-top:10px;">üéØ Zero b≈Çƒôd√≥w! Perfekcja!</div>';
        }

        buildMasteryGrid();
        showScreen('gameoverScreen');
    }

    function buildLootSummary() {
        const section = document.getElementById('lootSummary');
        if (state.lootLog.length === 0) { section.innerHTML = ''; return; }

        // Count unique items
        const counts = {};
        for (const l of state.lootLog) {
            counts[l.itemKey] = (counts[l.itemKey] || 0) + 1;
        }

        // Sort by rarity
        const rarityOrder = { legendary: 0, epic: 1, rare: 2, uncommon: 3, common: 4 };
        const sorted = Object.entries(counts).sort((a, b) =>
            rarityOrder[MC_ITEMS[a[0]].rarity] - rarityOrder[MC_ITEMS[b[0]].rarity]
        );

        let html = '<h3>üéÅ ZDOBYTE PRZEDMIOTY:</h3><div class="loot-grid">';
        for (const [itemKey, qty] of sorted) {
            const item = MC_ITEMS[itemKey];
            const cls = item.rarity === 'rare' ? 'rare' : item.rarity === 'epic' ? 'epic' : item.rarity === 'legendary' ? 'legendary' : '';
            html += `<div class="loot-card ${cls}"><div class="loot-icon">${item.icon}</div><div class="loot-name">${item.name}</div><div class="loot-qty">√ó${qty}</div></div>`;
        }
        html += '</div>';
        section.innerHTML = html;
    }

    function buildMasteryGrid() {
        const section = document.getElementById('masterySection');
        const entries = Object.entries(state.masteryMap);
        if (entries.length === 0) { section.innerHTML = ''; return; }
        let html = '<h3>üìä MAPA OPANOWANIA:</h3><div class="mastery-grid">';
        entries.sort((a, b) => { const [a1,a2]=a[0].split('√ó').map(Number); const [b1,b2]=b[0].split('√ó').map(Number); return (a1*100+a2)-(b1*100+b2); });
        for (const [key, data] of entries) {
            const pct = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
            let cls = '', stars = '';
            if (data.total > 0) { if (pct >= 80) { cls = 'strong'; stars = '‚≠ê'.repeat(Math.min(3, data.streak)); } else if (pct >= 50) { stars = '‚≠ê'; } else { cls = 'weak'; } }
            html += `<div class="mastery-cell ${cls}">${key.replace('√ó',' √ó ')}<br><span class="mastery-stars">${stars||'‚Äî'}</span><br>${data.total > 0 ? `${pct}%` : '‚Äî'}</div>`;
        }
        html += '</div>'; section.innerHTML = html;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function updateUI() {
        document.getElementById('score').textContent = state.score;
        document.getElementById('correct').textContent = state.correct;
        document.getElementById('total').textContent = state.total;
        document.getElementById('levelDisplay').textContent = state.level;

        const xpPct = (state.xp / state.xpToNext) * 100;
        document.getElementById('xpBar').style.width = xpPct + '%';
        document.getElementById('xpText').textContent = `${state.xp} / ${state.xpToNext} XP`;
        document.getElementById('xpBarText').textContent = `Poziom ${state.level}`;

        renderCombo();
        renderCurrentGoal();
        renderTrophyShelf();
        renderInventory();
    }

    function renderInventory() {
        const inv = document.getElementById('inventory');
        inv.innerHTML = '';
        // Sort by rarity (best first)
        const rarityOrder = { legendary: 0, epic: 1, rare: 2, uncommon: 3, common: 4 };
        const entries = Object.entries(state.inventory)
            .filter(([_, c]) => c > 0)
            .sort((a, b) => rarityOrder[MC_ITEMS[a[0]].rarity] - rarityOrder[MC_ITEMS[b[0]].rarity]);

        if (entries.length === 0) {
            // Show empty slots
            for (let i = 0; i < 9; i++) { const s = document.createElement('div'); s.className = 'inv-slot'; inv.appendChild(s); }
            return;
        }

        for (const [itemKey, count] of entries) {
            const item = MC_ITEMS[itemKey];
            const slot = document.createElement('div');
            const isLeg = item.rarity === 'legendary';
            slot.className = 'inv-slot active' + (isLeg ? ' legendary' : '');
            slot.innerHTML = `
                ${item.icon}<span class="count">${count}</span>
                <div class="inv-tooltip">
                    <div class="tt-name ${item.rarity === 'rare' ? 'rare' : item.rarity === 'epic' ? 'epic' : item.rarity === 'legendary' ? 'legendary' : ''}">${item.name}</div>
                    <div class="tt-desc">${item.desc}</div>
                    <div class="tt-rarity">${item.rarity.toUpperCase()}</div>
                </div>
            `;
            inv.appendChild(slot);
        }
        // Fill remaining slots
        const remaining = Math.max(0, 9 - entries.length);
        for (let i = 0; i < remaining; i++) { const s = document.createElement('div'); s.className = 'inv-slot'; inv.appendChild(s); }
    }

    function getNextGoal() {
        for (const ach of achievementList) {
            if (!state.achievements.has(ach.id)) return ach;
        }
        return null; // all done!
    }

    function renderCurrentGoal() {
        const container = document.getElementById('goalContent');
        const goal = getNextGoal();

        if (!goal) {
            container.innerHTML = '<div class="goal-done-msg">üèÜ Wszystkie nagrody zdobyte! Jeste≈õ LEGENDƒÑ! üëë</div>';
            return;
        }

        const prog = goal.progress(state);
        const pct = Math.min(100, Math.round((prog.cur / prog.max) * 100));
        const isFull = pct >= 100;

        container.innerHTML = `
            <div class="goal-icon" id="goalIcon">${goal.icon}</div>
            <div class="goal-info">
                <div class="goal-title">${goal.title}</div>
                <div class="goal-desc">${goal.desc}</div>
                <div class="goal-progress-bg">
                    <div class="goal-progress-fill${isFull ? ' full' : ''}" style="width:${pct}%"></div>
                    <div class="goal-progress-text">${prog.label}: ${Math.min(prog.cur, prog.max)} / ${prog.max}</div>
                </div>
            </div>
        `;
    }

    function renderTrophyShelf() {
        const shelf = document.getElementById('trophyShelf');
        shelf.innerHTML = '';

        for (const ach of achievementList) {
            const slot = document.createElement('div');
            const isEarned = state.achievements.has(ach.id);
            const isNew = state._newTrophies && state._newTrophies.has(ach.id);

            slot.className = 'trophy-slot' + (isEarned ? ' earned' : ' empty') + (isNew ? ' new-earned' : '');

            if (isEarned) {
                slot.innerHTML = `
                    ${ach.icon}
                    <div class="trophy-tooltip">
                        <div class="tt-name">${ach.title}</div>
                        <div class="tt-desc">${ach.desc}</div>
                    </div>
                `;
            }

            shelf.appendChild(slot);
        }

        // Clear new flags after render
        if (state._newTrophies) {
            setTimeout(() => { state._newTrophies = null; }, 1000);
        }
    }

    function checkAchievements() {
        let anyNew = false;
        for (const ach of achievementList) {
            if (!state.achievements.has(ach.id) && ach.check(state)) {
                state.achievements.add(ach.id);
                if (!state._newTrophies) state._newTrophies = new Set();
                state._newTrophies.add(ach.id);
                anyNew = true;
            }
        }
        if (anyNew) {
            // Flash the goal panel
            const panel = document.getElementById('goalContent');
            panel.classList.add('completed');
            const icon = document.getElementById('goalIcon');
            if (icon) icon.classList.add('earned');

            // After celebration, update to next goal
            setTimeout(() => {
                panel.classList.remove('completed');
                renderCurrentGoal();
                renderTrophyShelf();
            }, 1500);
        } else {
            renderCurrentGoal();
        }
    }

    function showAchievement(icon, title, desc) {
        // Mini floating notification for level-ups etc.
        const el = document.createElement('div');
        el.className = 'float-score';
        el.style.color = '#FCDB05';
        el.style.fontSize = '11px';
        el.textContent = `${icon} ${title}`;
        el.style.left = (window.innerWidth / 2 - 80) + 'px';
        el.style.top = (window.innerHeight / 2 - 120) + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1200);
        renderCurrentGoal();
        renderTrophyShelf();
    }

    function spawnParticles(count, colors) {
        const c = document.getElementById('particles');
        const cx = window.innerWidth / 2, cy = window.innerHeight / 2;
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div'); p.className = 'particle';
            p.style.left = (cx + (Math.random() - 0.5) * 200) + 'px';
            p.style.top = (cy + (Math.random() - 0.5) * 100) + 'px';
            p.style.background = colors[Math.floor(Math.random() * colors.length)];
            c.appendChild(p); setTimeout(() => p.remove(), 1000);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Leaderboard System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function getLeaderboard(difficulty) {
        try {
            const data = localStorage.getItem('mc_tabliczka_lb_' + difficulty);
            return data ? JSON.parse(data) : [];
        } catch(e) { return []; }
    }

    function saveToLeaderboard(difficulty, name, score, level, pct) {
        const lb = getLeaderboard(difficulty);

        // Check for duplicate name
        let displayName = name;
        const existingNames = lb.map(e => e.name);
        if (existingNames.includes(name)) {
            // Add hash to make unique
            let hash = 1;
            while (existingNames.includes(name + '#' + hash)) hash++;
            displayName = name + '#' + hash;
        }

        lb.push({ name: displayName, score, level, pct, date: Date.now() });
        lb.sort((a, b) => b.score - a.score);
        // Keep top 20
        if (lb.length > 20) lb.length = 20;
        localStorage.setItem('mc_tabliczka_lb_' + difficulty, JSON.stringify(lb));
        return displayName;
    }

    function renderLeaderboard(difficulty, highlightName) {
        const lb = getLeaderboard(difficulty);
        if (lb.length === 0) {
            return '<div style="text-align:center;font-size:8px;color:#555;padding:16px;">Brak wynik√≥w. Zagraj ≈ºeby siƒô tu pojawiƒá!</div>';
        }

        let html = '<table class="lb-table"><thead><tr><th>#</th><th>Gracz</th><th>üíé</th><th>‚¨ÜÔ∏è</th><th>‚úÖ</th></tr></thead><tbody>';
        for (let i = 0; i < lb.length; i++) {
            const e = lb[i];
            const isCurrent = highlightName && e.name === highlightName;
            const rankCls = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1);
            html += `<tr class="${isCurrent ? 'current' : ''}">
                <td class="lb-rank ${rankCls}">${medal}</td>
                <td class="lb-name">${e.name}</td>
                <td class="lb-score">${e.score}</td>
                <td>${e.level}</td>
                <td>${e.pct}%</td>
            </tr>`;
        }
        html += '</tbody></table>';
        return html;
    }

    let currentLbTab = 'easy';
    function showLeaderboardTab(diff, btn) {
        currentLbTab = diff;
        if (btn) {
            btn.closest('.difficulty').querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        document.getElementById('leaderboardContent').innerHTML = renderLeaderboard(diff);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Brainrot Collection System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function checkBrainrotUnlocks(score) {
        const collection = getBrainrotCollection();
        const newlyUnlocked = [];

        for (const br of BRAINROT_CHARS) {
            if (score >= br.goal) {
                const prev = collection[br.id];
                if (!prev || score > prev.bestScore) {
                    const wasOwned = prev && prev.owned;
                    collection[br.id] = { owned: true, bestScore: score, date: Date.now() };
                    if (!wasOwned) {
                        newlyUnlocked.push(br);
                    }
                }
            }
        }

        saveBrainrotCollection(collection);
        return newlyUnlocked;
    }

    function renderCatalog() {
        const container = document.getElementById('catalogContent');
        const collection = getBrainrotCollection();
        // Get best score ever across all sessions for progress display
        let bestEver = 0;
        try { const lb = ['easy','medium','hard'].flatMap(d => getLeaderboard(d)); bestEver = lb.reduce((m,e) => Math.max(m, e.score), 0); } catch(e) {}

        let html = '';
        for (const br of BRAINROT_CHARS) {
            const data = collection[br.id];
            const isOwned = data && data.owned;
            const rarCls = br.rarity;

            html += `<div class="brainrot-card ${rarCls}${isOwned ? ' owned' : ''}">`;
            html += `<div class="brainrot-icon${isOwned ? '' : ' locked'}"><img src="${br.img}" alt="${br.name}" loading="lazy"></div>`;
            html += `<div class="brainrot-name">${isOwned ? br.name : '???'}</div>`;
            html += `<div class="brainrot-rarity ${rarCls}">${rarCls === 'god' ? 'GOD TIER' : rarCls.toUpperCase()}</div>`;

            if (isOwned) {
                html += `<div class="brainrot-desc">${br.desc}</div>`;
                html += `<div class="brainrot-stats">‚ö° ${br.power}<br>üí¨ "${br.catchphrase}"</div>`;
                html += `<div class="brainrot-owned-badge">‚úÖ STILL THE BRAINROT! (${data.bestScore}üíé)</div>`;
            } else {
                const pct = Math.min(100, Math.round((bestEver / br.goal) * 100));
                html += `<div class="brainrot-goal">üîí Potrzebujesz ${br.goal}üíé w jednej rundzie</div>`;
                html += `<div class="brainrot-progress-bg"><div class="brainrot-progress-fill${pct >= 100 ? ' full' : ''}" style="width:${pct}%"></div></div>`;
                html += `<div style="font-size:6px;color:#666;margin-top:2px;">Tw√≥j rekord: ${bestEver}üíé</div>`;
            }

            html += '</div>';
        }
        container.innerHTML = html;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Helpers
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }

    // Load saved name + init leaderboard screen
    (function() {
        const saved = localStorage.getItem('mc_tabliczka_name');
        if (saved) document.getElementById('playerName').value = saved;
    })();
</script>
</body>
</html>